# Diagramas de Actividades - CASTOR ELECCIONES

## 1. Vista General de Procesos

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           PROCESOS PRINCIPALES                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐
│  Análisis Campaña   │  │  Procesamiento OCR  │  │   Revisión HITL     │
│  (Flujo Principal)  │  │  Formulario E-14    │  │   (Human-in-Loop)   │
└─────────────────────┘  └─────────────────────┘  └─────────────────────┘

┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐
│    Chat RAG         │  │   Autenticación     │  │    Pronósticos      │
│  (Asistente IA)     │  │   de Usuario        │  │    Electorales      │
└─────────────────────┘  └─────────────────────┘  └─────────────────────┘

┌─────────────────────┐  ┌─────────────────────┐
│  Gestión Alertas    │  │  Reconciliación     │
│                     │  │  de Votos           │
└─────────────────────┘  └─────────────────────┘
```

---

## 2. Análisis de Campaña Electoral

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                    ANÁLISIS DE CAMPAÑA - DIAGRAMA DE ACTIVIDADES                     │
└─────────────────────────────────────────────────────────────────────────────────────┘

                                       ●
                                       │
                                       ▼
                            ┌─────────────────────┐
                            │  Recibir parámetros │
                            │  (ubicación, tema,  │
                            │   candidato)        │
                            └──────────┬──────────┘
                                       │
                                       ▼
                                   ◇───────◇
                                 ╱           ╲
                               ╱  ¿Parámetros ╲
                              ╱    válidos?    ╲
                              ╲               ╱
                                ╲           ╱
                                   ◇───────◇
                                  │         │
                            [Sí]  │         │ [No]
                                  │         │
                                  ▼         ▼
                                  │    ┌─────────────┐
                                  │    │Retornar     │
                                  │    │Error 400    │
                                  │    └──────┬──────┘
                                  │           │
                                  │           ▼
                                  │           ◉
                                  │
                                  ▼
                            ┌─────────────────────┐
                            │   Verificar caché   │
                            │   (Redis TTL 24h)   │
                            └──────────┬──────────┘
                                       │
                                       ▼
                                   ◇───────◇
                                 ╱           ╲
                               ╱  ¿Cache hit?  ╲
                              ╱                 ╲
                              ╲               ╱
                                ╲           ╱
                                   ◇───────◇
                                  │         │
                            [Sí]  │         │ [No]
                                  │         │
                                  ▼         │
                            ┌───────────┐   │
                            │ Retornar  │   │
                            │ de caché  │   │
                            └─────┬─────┘   │
                                  │         │
                                  │         ▼
                                  │   ┌─────────────────────┐
                                  │   │  Verificar límite   │
                                  │   │  diario Twitter     │
                                  │   │  (3 req/día)        │
                                  │   └──────────┬──────────┘
                                  │              │
                                  │              ▼
                                  │          ◇───────◇
                                  │        ╱           ╲
                                  │      ╱  ¿Límite     ╲
                                  │     ╱   excedido?    ╲
                                  │     ╲               ╱
                                  │       ╲           ╱
                                  │          ◇───────◇
                                  │         │         │
                                  │   [Sí]  │         │ [No]
                                  │         │         │
                                  │         ▼         │
                                  │   ┌───────────┐   │
                                  │   │Error 429  │   │
                                  │   │Rate Limit │   │
                                  │   └─────┬─────┘   │
                                  │         │         │
                                  │         ▼         │
                                  │         ◉         │
                                  │                   │
                                  │                   ▼
                                  │   ═══════════════════════════════════════
                                  │   ║           FORK (Paralelo)           ║
                                  │   ═══════════════════════════════════════
                                  │         │                   │
                                  │         ▼                   ▼
                                  │   ┌───────────────┐   ┌───────────────┐
                                  │   │   Obtener     │   │   Buscar      │
                                  │   │   Trending    │   │   Tweets      │
                                  │   │   Topics      │   │   por tema    │
                                  │   └───────┬───────┘   └───────┬───────┘
                                  │           │                   │
                                  │           ▼                   ▼
                                  │   ┌───────────────┐   ┌───────────────┐
                                  │   │  Twitter API  │   │  Twitter API  │
                                  │   │  /trends      │   │  /search      │
                                  │   └───────┬───────┘   └───────┬───────┘
                                  │           │                   │
                                  │   ═══════════════════════════════════════
                                  │   ║              JOIN                   ║
                                  │   ═══════════════════════════════════════
                                  │                   │
                                  │                   ▼
                                  │         ┌─────────────────────┐
                                  │         │  Analizar Sentiment │
                                  │         │  con BETO           │
                                  │         │  (batch processing) │
                                  │         └──────────┬──────────┘
                                  │                    │
                                  │                    ▼
                                  │         ┌─────────────────────┐
                                  │         │  Clasificar por     │
                                  │         │  tema PND           │
                                  │         │  (keywords + embed) │
                                  │         └──────────┬──────────┘
                                  │                    │
                                  │                    ▼
                                  │         ┌─────────────────────┐
                                  │         │  Calcular métricas  │
                                  │         │  ISN, ICR, etc.     │
                                  │         └──────────┬──────────┘
                                  │                    │
                                  │   ═══════════════════════════════════════
                                  │   ║     FORK (Generación Paralela)      ║
                                  │   ═══════════════════════════════════════
                                  │         │           │           │
                                  │         ▼           ▼           ▼
                                  │   ┌─────────┐ ┌─────────┐ ┌─────────┐
                                  │   │ Generar │ │ Generar │ │ Generar │
                                  │   │ Summary │ │Strategy │ │ Speech  │
                                  │   │ (GPT-4o)│ │(GPT-4o) │ │(GPT-4o) │
                                  │   └────┬────┘ └────┬────┘ └────┬────┘
                                  │        │          │          │
                                  │   ═══════════════════════════════════════
                                  │   ║              JOIN                   ║
                                  │   ═══════════════════════════════════════
                                  │                    │
                                  │                    ▼
                                  │         ┌─────────────────────┐
                                  │         │  Generar datos      │
                                  │         │  para gráficos      │
                                  │         └──────────┬──────────┘
                                  │                    │
                                  │   ═══════════════════════════════════════
                                  │   ║     FORK (Persistencia Paralela)    ║
                                  │   ═══════════════════════════════════════
                                  │         │                   │
                                  │         ▼                   ▼
                                  │   ┌───────────────┐   ┌───────────────┐
                                  │   │   Guardar en  │   │   Indexar en  │
                                  │   │   PostgreSQL  │   │   ChromaDB    │
                                  │   └───────┬───────┘   └───────┬───────┘
                                  │           │                   │
                                  │   ═══════════════════════════════════════
                                  │   ║              JOIN                   ║
                                  │   ═══════════════════════════════════════
                                  │                    │
                                  │                    ▼
                                  │         ┌─────────────────────┐
                                  │         │   Guardar en caché  │
                                  │         │   (Redis TTL 24h)   │
                                  │         └──────────┬──────────┘
                                  │                    │
                                  └────────────────────┤
                                                       │
                                                       ▼
                                            ┌─────────────────────┐
                                            │  Retornar respuesta │
                                            │  JSON completa      │
                                            └──────────┬──────────┘
                                                       │
                                                       ▼
                                                       ◉
```

---

## 3. Procesamiento OCR de Formulario E-14

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                  PROCESAMIENTO OCR E-14 - DIAGRAMA DE ACTIVIDADES                    │
└─────────────────────────────────────────────────────────────────────────────────────┘

          │ Observador                    │ Sistema E-14                │ Claude API
          │                               │                             │
          ●                               │                             │
          │                               │                             │
          ▼                               │                             │
┌─────────────────┐                       │                             │
│ Seleccionar     │                       │                             │
│ ubicación       │                       │                             │
│ (dept/mun/mesa) │                       │                             │
└────────┬────────┘                       │                             │
         │                                │                             │
         ▼                                │                             │
┌─────────────────┐                       │                             │
│ Cargar archivo  │                       │                             │
│ (PDF/imagen)    │                       │                             │
└────────┬────────┘                       │                             │
         │                                │                             │
         │     upload(file)               │                             │
         │───────────────────────────────>│                             │
         │                                │                             │
         │                                ▼                             │
         │                      ┌─────────────────┐                     │
         │                      │ Validar archivo │                     │
         │                      │ (tipo, tamaño)  │                     │
         │                      └────────┬────────┘                     │
         │                               │                             │
         │                               ▼                             │
         │                           ◇───────◇                         │
         │                         ╱           ╲                       │
         │                       ╱  ¿Válido?    ╲                      │
         │                      ╱   size<=10MB   ╲                     │
         │                      ╲   pages<=20   ╱                      │
         │                        ╲           ╱                        │
         │                           ◇───────◇                         │
         │                          │         │                        │
         │                    [Sí]  │         │ [No]                   │
         │                          │         │                        │
         │                          │         ▼                        │
         │                          │   ┌───────────┐                  │
         │     error 400            │   │  Rechazar │                  │
         │<─────────────────────────┼───│  archivo  │                  │
         │                          │   └───────────┘                  │
         ▼                          │                                  │
┌─────────────────┐                 │                                  │
│ Mostrar error   │                 │                                  │
│ y reintentar    │                 │                                  │
└─────────────────┘                 │                                  │
                                    ▼                                  │
                          ┌─────────────────┐                          │
                          │ Calcular hash   │                          │
                          │ del archivo     │                          │
                          └────────┬────────┘                          │
                                   │                                   │
                                   ▼                                   │
                               ◇───────◇                               │
                             ╱           ╲                             │
                           ╱  ¿Duplicado? ╲                            │
                          ╱   (mismo hash) ╲                           │
                          ╲               ╱                            │
                            ╲           ╱                              │
                               ◇───────◇                               │
                              │         │                              │
                        [Sí]  │         │ [No]                         │
                              │         │                              │
                              ▼         │                              │
                        ┌───────────┐   │                              │
                        │  Alertar  │   │                              │
                        │ duplicado │   │                              │
                        └─────┬─────┘   │                              │
                              │         │                              │
                              ▼         │                              │
                          ◇───────◇     │                              │
                        ╱           ╲   │                              │
                      ╱  ¿Continuar? ╲  │                              │
                      ╲             ╱   │                              │
                        ╲         ╱     │                              │
                          ◇─────◇       │                              │
                         │       │      │                              │
                   [No]  │       │ [Sí] │                              │
                         │       │      │                              │
                         ▼       └──────┤                              │
                         ◉              │                              │
                                        ▼                              │
                          ┌─────────────────────┐                      │
                          │ Guardar archivo     │                      │
                          │ (S3/local storage)  │                      │
                          └──────────┬──────────┘                      │
                                     │                                 │
                                     ▼                                 │
                          ┌─────────────────────┐                      │
                          │ Crear FormInstance  │                      │
                          │ status: PENDING     │                      │
                          └──────────┬──────────┘                      │
                                     │                                 │
                                     ▼                                 │
                          ┌─────────────────────┐                      │
                          │ Convertir a imagen  │                      │
                          │ (pdf2image DPI=150) │                      │
                          └──────────┬──────────┘                      │
                                     │                                 │
                                     ▼                                 │
                          ┌─────────────────────┐                      │
                          │ Actualizar status:  │                      │
                          │ PROCESSING          │                      │
                          └──────────┬──────────┘                      │
                                     │                                 │
                     ════════════════════════════════                  │
                     ║  LOOP [para cada página]    ║                  │
                     ════════════════════════════════                  │
                                     │                                 │
                                     ▼                                 │
                          ┌─────────────────────┐                      │
                          │ Codificar imagen    │                      │
                          │ en Base64           │                      │
                          └──────────┬──────────┘                      │
                                     │                                 │
                                     │    POST /messages               │
                                     │    (image + prompt)             │
                                     │────────────────────────────────>│
                                     │                                 │
                                     │                                 ▼
                                     │                       ┌─────────────────┐
                                     │                       │ Claude Vision   │
                                     │                       │ OCR extraction  │
                                     │                       └────────┬────────┘
                                     │                                │
                                     │     {cells, confidence}        │
                                     │<───────────────────────────────│
                                     │                                │
                                     ▼                                │
                          ┌─────────────────────┐                     │
                          │ Guardar OCRFields   │                     │
                          │ con confianza       │                     │
                          └──────────┬──────────┘                     │
                                     │                                │
                     ════════════════════════════════                 │
                     ║         END LOOP              ║                 │
                     ════════════════════════════════                 │
                                     │                                │
                                     ▼                                │
                          ┌─────────────────────┐                     │
                          │ Parsear votos       │                     │
                          │ (vote_tallies)      │                     │
                          └──────────┬──────────┘                     │
                                     │                                │
                                     ▼                                │
                          ┌─────────────────────┐                     │
                          │ Ejecutar validación │                     │
                          │ aritmética          │                     │
                          └──────────┬──────────┘                     │
                                     │                                │
                                     ▼                                │
                               ◇─────────────◇                        │
                             ╱                 ╲                       │
                           ╱  ¿Validación OK?   ╲                      │
                          ╱   AND conf >= 0.85   ╲                     │
                          ╲                     ╱                      │
                            ╲                 ╱                        │
                               ◇─────────────◇                        │
                              │               │                        │
                        [Sí]  │               │ [No]                   │
                              │               │                        │
                              ▼               ▼                        │
                    ┌───────────────┐  ┌───────────────┐               │
                    │ status:       │  │ status:       │               │
                    │ COMPLETED     │  │ NEEDS_REVIEW  │               │
                    └───────┬───────┘  └───────┬───────┘               │
                            │                  │                       │
                            │                  ▼                       │
                            │          ┌───────────────┐               │
                            │          │ Crear alerta  │               │
                            │          │ (discrepancia)│               │
                            │          └───────┬───────┘               │
                            │                  │                       │
                            └────────┬─────────┘                       │
                                     │                                 │
                                     ▼                                 │
                          ┌─────────────────────┐                      │
                          │ Registrar en        │                      │
                          │ audit_log           │                      │
                          └──────────┬──────────┘                      │
                                     │                                 │
         │     response              │                                 │
         │<──────────────────────────│                                 │
         │                           │                                 │
         ▼                           │                                 │
┌─────────────────┐                  │                                 │
│ Ver confirmación│                  │                                 │
│ y estado        │                  │                                 │
└────────┬────────┘                  │                                 │
         │                           │                                 │
         ▼                           │                                 │
         ◉                           │                                 │
```

---

## 4. Revisión Manual HITL (Human-in-the-Loop)

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                    REVISIÓN HITL - DIAGRAMA DE ACTIVIDADES                           │
└─────────────────────────────────────────────────────────────────────────────────────┘

          │ Administrador                 │ Sistema E-14
          │                               │
          ●                               │
          │                               │
          ▼                               │
┌─────────────────┐                       │
│ Acceder a cola  │                       │
│ de revisión     │                       │
└────────┬────────┘                       │
         │                                │
         │     GET /review/pending        │
         │───────────────────────────────>│
         │                                │
         │                                ▼
         │                      ┌─────────────────────┐
         │                      │ Obtener formularios │
         │                      │ NEEDS_REVIEW        │
         │                      │ ordenados por:      │
         │                      │ 1. Severidad alerta │
         │                      │ 2. Fecha más antigua│
         │                      └──────────┬──────────┘
         │                                 │
         │     forms[]                     │
         │<────────────────────────────────│
         │                                 │
         ▼                                 │
┌─────────────────┐                        │
│ Ver lista de    │                        │
│ formularios     │                        │
│ pendientes      │                        │
└────────┬────────┘                        │
         │                                 │
         ▼                                 │
     ◇───────◇                             │
   ╱           ╲                           │
 ╱  ¿Hay forms  ╲                          │
╱   pendientes?  ╲                         │
╲               ╱                          │
  ╲           ╱                            │
     ◇───────◇                             │
    │         │                            │
[No]│         │ [Sí]                       │
    │         │                            │
    ▼         ▼                            │
    ◉   ┌─────────────────┐                │
        │ Seleccionar     │                │
        │ formulario      │                │
        └────────┬────────┘                │
                 │                         │
                 │  GET /review/{id}       │
                 │────────────────────────>│
                 │                         │
                 │                         ▼
                 │               ┌─────────────────────┐
                 │               │ Obtener:            │
                 │               │ - Imagen original   │
                 │               │ - Datos OCR         │
                 │               │ - Discrepancias     │
                 │               │ - Alertas asociadas │
                 │               └──────────┬──────────┘
                 │                          │
                 │    {form, image, data}   │
                 │<─────────────────────────│
                 │                          │
                 ▼                          │
       ┌─────────────────┐                  │
       │ Ver imagen lado │                  │
       │ a lado con      │                  │
       │ datos extraídos │                  │
       └────────┬────────┘                  │
                │                          │
                ▼                          │
       ┌─────────────────┐                  │
       │ Revisar campos  │                  │
       │ con discrepancia│                  │
       │ (resaltados)    │                  │
       └────────┬────────┘                  │
                │                          │
     ════════════════════════════          │
     ║  LOOP [cada discrepancia] ║          │
     ════════════════════════════          │
                │                          │
                ▼                          │
       ┌─────────────────┐                  │
       │ Comparar valor  │                  │
       │ OCR vs imagen   │                  │
       └────────┬────────┘                  │
                │                          │
                ▼                          │
            ◇───────◇                      │
          ╱           ╲                    │
        ╱  ¿Valor OCR  ╲                   │
       ╱   correcto?    ╲                  │
       ╲               ╱                   │
         ╲           ╱                     │
            ◇───────◇                      │
           │         │                     │
     [Sí]  │         │ [No]                │
           │         │                     │
           │         ▼                     │
           │   ┌─────────────────┐         │
           │   │ Ingresar valor  │         │
           │   │ correcto        │         │
           │   └────────┬────────┘         │
           │            │                  │
           └────────────┤                  │
                        │                  │
     ════════════════════════════          │
     ║       END LOOP            ║          │
     ════════════════════════════          │
                │                          │
                ▼                          │
       ┌─────────────────┐                  │
       │ Agregar notas   │                  │
       │ de revisión     │                  │
       └────────┬────────┘                  │
                │                          │
                ▼                          │
            ◇───────────◇                  │
          ╱               ╲                │
        ╱  ¿Aprobar o      ╲               │
       ╱   rechazar?        ╲              │
       ╲                   ╱               │
         ╲               ╱                 │
            ◇───────────◇                  │
           │             │                 │
   [Aprobar]             │ [Rechazar]      │
           │             │                 │
           ▼             ▼                 │
  ┌────────────────┐  ┌────────────────┐   │
  │POST /review/   │  │POST /review/   │   │
  │{id}/approve    │  │{id}/reject     │   │
  │{corrections,   │  │{reason}        │   │
  │ notes}         │  │                │   │
  └───────┬────────┘  └───────┬────────┘   │
          │                   │            │
          │                   │            │
          └─────────┬─────────┘            │
                    │                      │
                    │─────────────────────>│
                    │                      │
                    │                      ▼
                    │            ┌─────────────────────┐
                    │            │ Aplicar cambios     │
                    │            │ a vote_tallies      │
                    │            └──────────┬──────────┘
                    │                       │
                    │                       ▼
                    │            ┌─────────────────────┐
                    │            │ Actualizar status:  │
                    │            │ VALIDATED o FAILED  │
                    │            └──────────┬──────────┘
                    │                       │
                    │                       ▼
                    │            ┌─────────────────────┐
                    │            │ Registrar en        │
                    │            │ audit_log           │
                    │            │ (REVIEW_APPROVED o  │
                    │            │  REVIEW_REJECTED)   │
                    │            └──────────┬──────────┘
                    │                       │
                    │                       ▼
                    │            ┌─────────────────────┐
                    │            │ Resolver alertas    │
                    │            │ asociadas           │
                    │            └──────────┬──────────┘
                    │                       │
                    │        {success}      │
                    │<──────────────────────│
                    │                       │
                    ▼                       │
           ┌─────────────────┐              │
           │ Ver confirmación│              │
           └────────┬────────┘              │
                    │                       │
                    ▼                       │
               ◇─────────◇                  │
             ╱             ╲                │
           ╱  ¿Continuar    ╲               │
          ╱   revisando?     ╲              │
          ╲                 ╱               │
            ╲             ╱                 │
               ◇─────────◇                  │
              │           │                 │
        [Sí]  │           │ [No]            │
              │           │                 │
              │           ▼                 │
              │           ◉                 │
              │                             │
              └──────────────────┐          │
                                 │          │
            (volver a lista)     │          │
                                 ▼          │
                    [Ver lista de forms]    │
```

---

## 5. Chat RAG (Asistente IA)

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                        CHAT RAG - DIAGRAMA DE ACTIVIDADES                            │
└─────────────────────────────────────────────────────────────────────────────────────┘

                                       ●
                                       │
                                       ▼
                            ┌─────────────────────┐
                            │ Usuario ingresa     │
                            │ pregunta en chat    │
                            └──────────┬──────────┘
                                       │
                                       ▼
                            ┌─────────────────────┐
                            │ Obtener session_id  │
                            │ (crear si no existe)│
                            └──────────┬──────────┘
                                       │
                                       ▼
                            ┌─────────────────────┐
                            │ Cargar historial    │
                            │ de conversación     │
                            │ (últimos N mensajes)│
                            └──────────┬──────────┘
                                       │
                   ════════════════════════════════════════
                   ║           FORK (Paralelo)            ║
                   ════════════════════════════════════════
                            │                   │
                            ▼                   ▼
                  ┌─────────────────┐  ┌─────────────────────┐
                  │ Generar         │  │ Guardar pregunta    │
                  │ embedding de    │  │ en historial        │
                  │ la pregunta     │  │ (role: user)        │
                  │                 │  │                     │
                  │ OpenAI          │  │                     │
                  │ text-embedding- │  │                     │
                  │ 3-small         │  │                     │
                  └────────┬────────┘  └──────────┬──────────┘
                           │                      │
                   ════════════════════════════════════════
                   ║              JOIN                     ║
                   ════════════════════════════════════════
                                       │
                                       ▼
                            ┌─────────────────────┐
                            │ Búsqueda semántica  │
                            │ en ChromaDB         │
                            │ (top k=5 documentos)│
                            └──────────┬──────────┘
                                       │
                                       ▼
                                   ◇───────◇
                                 ╱           ╲
                               ╱  ¿Documentos ╲
                              ╱   relevantes?  ╲
                              ╲  (score > 0.7) ╱
                                ╲           ╱
                                   ◇───────◇
                                  │         │
                            [Sí]  │         │ [No]
                                  │         │
                                  ▼         ▼
                        ┌───────────────┐  ┌───────────────┐
                        │ Construir     │  │ Usar contexto │
                        │ contexto con  │  │ general       │
                        │ documentos    │  │ (sin RAG)     │
                        └───────┬───────┘  └───────┬───────┘
                                │                  │
                                └────────┬─────────┘
                                         │
                                         ▼
                            ┌─────────────────────┐
                            │ Construir prompt    │
                            │ con:                │
                            │ - System message    │
                            │ - Contexto RAG      │
                            │ - Historial chat    │
                            │ - Pregunta usuario  │
                            └──────────┬──────────┘
                                       │
                                       ▼
                            ┌─────────────────────┐
                            │ Llamar GPT-4o       │
                            │ (chat completion)   │
                            └──────────┬──────────┘
                                       │
                                       ▼
                                   ◇───────◇
                                 ╱           ╲
                               ╱  ¿Streaming   ╲
                              ╱   habilitado?   ╲
                              ╲               ╱
                                ╲           ╱
                                   ◇───────◇
                                  │         │
                            [Sí]  │         │ [No]
                                  │         │
                                  ▼         ▼
                    ┌───────────────────┐  ┌───────────────────┐
                    │ Enviar chunks     │  │ Esperar respuesta │
                    │ via SSE           │  │ completa          │
                    │                   │  │                   │
                    │ ════════════════  │  │                   │
                    │ ║ LOOP [chunks] ║  │  │                   │
                    │ ════════════════  │  │                   │
                    │        │          │  │                   │
                    │        ▼          │  │                   │
                    │ ┌─────────────┐   │  │                   │
                    │ │Send chunk   │   │  │                   │
                    │ │to client    │   │  │                   │
                    │ └──────┬──────┘   │  │                   │
                    │        │          │  │                   │
                    │ ════════════════  │  │                   │
                    │ ║   END LOOP   ║  │  │                   │
                    │ ════════════════  │  │                   │
                    └─────────┬─────────┘  └─────────┬─────────┘
                              │                      │
                              └──────────┬───────────┘
                                         │
                                         ▼
                   ════════════════════════════════════════
                   ║           FORK (Paralelo)            ║
                   ════════════════════════════════════════
                            │                   │
                            ▼                   ▼
                  ┌─────────────────┐  ┌─────────────────────┐
                  │ Guardar         │  │ Actualizar          │
                  │ respuesta en    │  │ tokens_used         │
                  │ historial       │  │ para billing        │
                  │ (role:assistant)│  │                     │
                  └────────┬────────┘  └──────────┬──────────┘
                           │                      │
                   ════════════════════════════════════════
                   ║              JOIN                     ║
                   ════════════════════════════════════════
                                         │
                                         ▼
                            ┌─────────────────────┐
                            │ Retornar respuesta  │
                            │ con fuentes citadas │
                            └──────────┬──────────┘
                                       │
                                       ▼
                                       ◉
```

---

## 6. Autenticación de Usuario

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                     AUTENTICACIÓN - DIAGRAMA DE ACTIVIDADES                          │
└─────────────────────────────────────────────────────────────────────────────────────┘

                                       ●
                                       │
                                       ▼
                            ┌─────────────────────┐
                            │ Usuario ingresa     │
                            │ email y password    │
                            └──────────┬──────────┘
                                       │
                                       ▼
                            ┌─────────────────────┐
                            │ Verificar rate      │
                            │ limit (5 req/s)     │
                            └──────────┬──────────┘
                                       │
                                       ▼
                                   ◇───────◇
                                 ╱           ╲
                               ╱  ¿Rate limit  ╲
                              ╱   excedido?     ╲
                              ╲               ╱
                                ╲           ╱
                                   ◇───────◇
                                  │         │
                            [Sí]  │         │ [No]
                                  │         │
                                  ▼         │
                        ┌───────────────┐   │
                        │ Error 429     │   │
                        │ Too Many      │   │
                        │ Requests      │   │
                        └───────┬───────┘   │
                                │           │
                                ▼           │
                                ◉           │
                                            │
                                            ▼
                            ┌─────────────────────┐
                            │ Buscar usuario      │
                            │ por email           │
                            └──────────┬──────────┘
                                       │
                                       ▼
                                   ◇───────◇
                                 ╱           ╲
                               ╱  ¿Usuario    ╲
                              ╱   existe?      ╲
                              ╲               ╱
                                ╲           ╱
                                   ◇───────◇
                                  │         │
                            [No]  │         │ [Sí]
                                  │         │
                                  ▼         │
                        ┌───────────────┐   │
                        │ Error 401     │   │
                        │ Invalid       │   │
                        │ credentials   │   │
                        └───────┬───────┘   │
                                │           │
                                ▼           │
                                ◉           │
                                            │
                                            ▼
                                   ◇───────◇
                                 ╱           ╲
                               ╱  ¿Usuario    ╲
                              ╱   activo?      ╲
                              ╲               ╱
                                ╲           ╱
                                   ◇───────◇
                                  │         │
                            [No]  │         │ [Sí]
                                  │         │
                                  ▼         │
                        ┌───────────────┐   │
                        │ Error 403     │   │
                        │ Account       │   │
                        │ disabled      │   │
                        └───────┬───────┘   │
                                │           │
                                ▼           │
                                ◉           │
                                            │
                                            ▼
                            ┌─────────────────────┐
                            │ Verificar password  │
                            │ con bcrypt          │
                            └──────────┬──────────┘
                                       │
                                       ▼
                                   ◇───────◇
                                 ╱           ╲
                               ╱  ¿Password   ╲
                              ╱   correcto?    ╲
                              ╲               ╱
                                ╲           ╱
                                   ◇───────◇
                                  │         │
                            [No]  │         │ [Sí]
                                  │         │
                                  ▼         │
                        ┌───────────────┐   │
                        │ Incrementar   │   │
                        │ failed_attempts│   │
                        └───────┬───────┘   │
                                │           │
                                ▼           │
                            ◇───────◇       │
                          ╱           ╲     │
                        ╱  attempts    ╲    │
                       ╱   >= 5?        ╲   │
                       ╲               ╱    │
                         ╲           ╱      │
                            ◇───────◇       │
                           │         │      │
                     [Sí]  │         │[No]  │
                           │         │      │
                           ▼         ▼      │
                  ┌──────────────┐   │      │
                  │Bloquear cuenta│   │      │
                  │temporalmente │   │      │
                  └───────┬──────┘   │      │
                          │          │      │
                          └────┬─────┘      │
                               │            │
                               ▼            │
                        ┌───────────────┐   │
                        │ Error 401     │   │
                        └───────┬───────┘   │
                                │           │
                                ▼           │
                                ◉           │
                                            │
                                            ▼
                   ════════════════════════════════════════
                   ║           FORK (Paralelo)            ║
                   ════════════════════════════════════════
                            │                   │
                            ▼                   ▼
                  ┌─────────────────┐  ┌─────────────────────┐
                  │ Generar         │  │ Generar             │
                  │ access_token    │  │ refresh_token       │
                  │ (JWT, 1h)       │  │ (JWT, 24h)          │
                  └────────┬────────┘  └──────────┬──────────┘
                           │                      │
                   ════════════════════════════════════════
                   ║              JOIN                     ║
                   ════════════════════════════════════════
                                         │
                                         ▼
                   ════════════════════════════════════════
                   ║           FORK (Paralelo)            ║
                   ════════════════════════════════════════
                            │                   │
                            ▼                   ▼
                  ┌─────────────────┐  ┌─────────────────────┐
                  │ Crear sesión    │  │ Actualizar          │
                  │ en Redis        │  │ last_login          │
                  │ (TTL 24h)       │  │ del usuario         │
                  └────────┬────────┘  └──────────┬──────────┘
                           │                      │
                   ════════════════════════════════════════
                   ║              JOIN                     ║
                   ════════════════════════════════════════
                                         │
                                         ▼
                            ┌─────────────────────┐
                            │ Resetear            │
                            │ failed_attempts = 0 │
                            └──────────┬──────────┘
                                       │
                                       ▼
                            ┌─────────────────────┐
                            │ Retornar tokens     │
                            │ {access, refresh,   │
                            │  expires_in}        │
                            └──────────┬──────────┘
                                       │
                                       ▼
                                       ◉
```

---

## 7. Generación de Pronósticos

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      PRONÓSTICOS - DIAGRAMA DE ACTIVIDADES                           │
└─────────────────────────────────────────────────────────────────────────────────────┘

                                       ●
                                       │
                                       ▼
                            ┌─────────────────────┐
                            │ Recibir parámetros  │
                            │ (candidato, días)   │
                            └──────────┬──────────┘
                                       │
                                       ▼
                            ┌─────────────────────┐
                            │ Obtener datos       │
                            │ históricos          │
                            │ (últimos 90 días)   │
                            └──────────┬──────────┘
                                       │
                                       ▼
                                   ◇───────◇
                                 ╱           ╲
                               ╱  ¿Suficientes ╲
                              ╱   datos? (>30)  ╲
                              ╲               ╱
                                ╲           ╱
                                   ◇───────◇
                                  │         │
                            [No]  │         │ [Sí]
                                  │         │
                                  ▼         │
                        ┌───────────────┐   │
                        │ Error:        │   │
                        │ Insufficient  │   │
                        │ data          │   │
                        └───────┬───────┘   │
                                │           │
                                ▼           │
                                ◉           │
                                            │
                                            ▼
                   ════════════════════════════════════════
                   ║    FORK (Cálculo de Métricas)        ║
                   ════════════════════════════════════════
                     │         │         │         │
                     ▼         ▼         ▼         ▼
               ┌─────────┐┌─────────┐┌─────────┐┌─────────┐
               │Calcular ││Calcular ││Calcular ││Calcular │
               │  ISN    ││  ICR    ││Momentum ││  SVE    │
               │         ││         ││         ││         │
               │Positivos││Volumen  ││Velocidad││Votante  │
               │-Negativ.││relativo ││cambio   ││esperado │
               └────┬────┘└────┬────┘└────┬────┘└────┬────┘
                    │          │          │          │
                   ════════════════════════════════════════
                   ║              JOIN                     ║
                   ════════════════════════════════════════
                                         │
                                         ▼
                            ┌─────────────────────┐
                            │ Calcular ICCE       │
                            │ (Índice Compuesto)  │
                            │                     │
                            │ ICCE = ISN*0.4 +    │
                            │        ICR*0.3 +    │
                            │        Momentum*0.3 │
                            └──────────┬──────────┘
                                       │
                                       ▼
                            ┌─────────────────────┐
                            │ Aplicar modelo      │
                            │ Holt-Winters        │
                            │ (triple exponential │
                            │  smoothing)         │
                            └──────────┬──────────┘
                                       │
                                       ▼
                            ┌─────────────────────┐
                            │ Generar predicciones│
                            │ para próximos N días│
                            │ (default: 14 días)  │
                            └──────────┬──────────┘
                                       │
                                       ▼
                            ┌─────────────────────┐
                            │ Calcular intervalos │
                            │ de confianza        │
                            │ (95%)               │
                            └──────────┬──────────┘
                                       │
                                       ▼
                            ┌─────────────────────┐
                            │ Calcular IVN        │
                            │ (Índice Votante     │
                            │  Neto)              │
                            └──────────┬──────────┘
                                       │
                                       ▼
                            ┌─────────────────────┐
                            │ Determinar          │
                            │ tendencia           │
                            │ (UP/DOWN/STABLE)    │
                            └──────────┬──────────┘
                                       │
                   ════════════════════════════════════════
                   ║           FORK (Paralelo)            ║
                   ════════════════════════════════════════
                            │                   │
                            ▼                   ▼
                  ┌─────────────────┐  ┌─────────────────────┐
                  │ Guardar         │  │ Generar datos       │
                  │ pronóstico      │  │ para gráficos       │
                  │ en PostgreSQL   │  │ (Chart.js format)   │
                  └────────┬────────┘  └──────────┬──────────┘
                           │                      │
                   ════════════════════════════════════════
                   ║              JOIN                     ║
                   ════════════════════════════════════════
                                         │
                                         ▼
                            ┌─────────────────────┐
                            │ Retornar respuesta  │
                            │ {icce, isn, icr,    │
                            │  momentum, sve, ivn,│
                            │  predictions[],     │
                            │  trend, charts}     │
                            └──────────┬──────────┘
                                       │
                                       ▼
                                       ◉
```

---

## 8. Reconciliación de Votos

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                    RECONCILIACIÓN - DIAGRAMA DE ACTIVIDADES                          │
└─────────────────────────────────────────────────────────────────────────────────────┘

                                       ●
                                       │
                                       ▼
                            ┌─────────────────────┐
                            │ Detectar múltiples  │
                            │ formularios para    │
                            │ misma mesa          │
                            └──────────┬──────────┘
                                       │
                                       ▼
                            ┌─────────────────────┐
                            │ Obtener todos los   │
                            │ formularios         │
                            │ VALIDATED para mesa │
                            └──────────┬──────────┘
                                       │
                                       ▼
                                   ◇───────◇
                                 ╱           ╲
                               ╱  ¿Múltiples  ╲
                              ╱   formularios? ╲
                              ╲               ╱
                                ╲           ╱
                                   ◇───────◇
                                  │         │
                            [No]  │         │ [Sí]
                                  │         │
                                  ▼         │
                        ┌───────────────┐   │
                        │ Usar único    │   │
                        │ formulario    │   │
                        │ como fuente   │   │
                        └───────┬───────┘   │
                                │           │
                                │           ▼
                                │  ┌─────────────────────┐
                                │  │ Comparar datos de   │
                                │  │ todos los forms     │
                                │  └──────────┬──────────┘
                                │             │
                                │             ▼
                                │         ◇───────◇
                                │       ╱           ╲
                                │     ╱  ¿Todos los  ╲
                                │    ╱   datos        ╲
                                │   ╱    coinciden?    ╲
                                │   ╲                 ╱
                                │     ╲             ╱
                                │       ╲         ╱
                                │         ◇─────◇
                                │        │       │
                                │  [Sí]  │       │ [No]
                                │        │       │
                                │        ▼       ▼
                                │  ┌─────────┐ ┌─────────────────┐
                                │  │ Auto-   │ │ Ordenar por     │
                                │  │ select  │ │ confianza OCR   │
                                │  │ (conf   │ │ descendente     │
                                │  │ mayor)  │ └────────┬────────┘
                                │  └────┬────┘          │
                                │       │               ▼
                                │       │      ┌─────────────────────┐
                                │       │      │ Crear               │
                                │       │      │ Reconciliation      │
                                │       │      │ status: PROVISIONAL │
                                │       │      └──────────┬──────────┘
                                │       │                 │
                                │       │                 ▼
                                │       │      ┌─────────────────────┐
                                │       │      │ Seleccionar form    │
                                │       │      │ con mayor confianza │
                                │       │      │ como winner         │
                                │       │      └──────────┬──────────┘
                                │       │                 │
                                │       │                 ▼
                                │       │      ┌─────────────────────┐
                                │       │      │ Marcar diferencias  │
                                │       │      │ como discrepancias  │
                                │       │      └──────────┬──────────┘
                                │       │                 │
                                │       │                 ▼
                                │       │      ┌─────────────────────┐
                                │       │      │ Crear alerta        │
                                │       │      │ RECONCILIATION_     │
                                │       │      │ NEEDED              │
                                │       │      └──────────┬──────────┘
                                │       │                 │
                                │       │                 ▼
                                │       │             ◇───────◇
                                │       │           ╱           ╲
                                │       │         ╱  ¿Diferencia ╲
                                │       │        ╱   > umbral?    ╲
                                │       │        ╲   (>5 votos)  ╱
                                │       │          ╲           ╱
                                │       │             ◇───────◇
                                │       │            │         │
                                │       │      [No]  │         │ [Sí]
                                │       │            │         │
                                │       │            ▼         ▼
                                │       │    ┌───────────┐ ┌───────────┐
                                │       │    │ severity: │ │ severity: │
                                │       │    │ MEDIUM    │ │ CRITICAL  │
                                │       │    └─────┬─────┘ └─────┬─────┘
                                │       │          │             │
                                │       │          └──────┬──────┘
                                │       │                 │
                                └───────┼─────────────────┘
                                        │
                                        ▼
                            ┌─────────────────────┐
                            │ Esperar decisión    │
                            │ del administrador   │
                            │ (si PROVISIONAL)    │
                            └──────────┬──────────┘
                                       │
                                       ▼
                                   ◇───────◇
                                 ╱           ╲
                               ╱  ¿Admin      ╲
                              ╱   confirma?    ╲
                              ╲               ╱
                                ╲           ╱
                                   ◇───────◇
                                  │         │
                            [Sí]  │         │ [Disputa]
                                  │         │
                                  ▼         ▼
                        ┌───────────────┐  ┌───────────────┐
                        │ status: FINAL │  │ status:       │
                        │               │  │ DISPUTED      │
                        │ Establecer    │  │               │
                        │ fuente de     │  │ Escalar a     │
                        │ verdad        │  │ nivel superior│
                        └───────┬───────┘  └───────┬───────┘
                                │                  │
                                └────────┬─────────┘
                                         │
                                         ▼
                            ┌─────────────────────┐
                            │ Registrar en        │
                            │ audit_log           │
                            │ (RECONCILE action)  │
                            └──────────┬──────────┘
                                       │
                                       ▼
                            ┌─────────────────────┐
                            │ Actualizar          │
                            │ resultados          │
                            │ agregados           │
                            └──────────┬──────────┘
                                       │
                                       ▼
                                       ◉
```

---

## 9. Resumen de Actividades por Proceso

| Proceso | Actividades | Decisiones | Forks/Joins | Complejidad |
|---------|-------------|------------|-------------|-------------|
| **Análisis Campaña** | 15 | 3 | 4 | Alta |
| **OCR E-14** | 12 | 4 | 1 (loop) | Alta |
| **Revisión HITL** | 10 | 4 | 1 (loop) | Media |
| **Chat RAG** | 10 | 2 | 3 | Media |
| **Autenticación** | 12 | 5 | 2 | Media |
| **Pronósticos** | 11 | 1 | 2 | Media |
| **Reconciliación** | 13 | 4 | 0 | Alta |

---

## 10. Notación UML Utilizada

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              NOTACIÓN UML                                            │
└─────────────────────────────────────────────────────────────────────────────────────┘

    ●           Estado inicial (inicio del proceso)

    ◉           Estado final (fin del proceso)

┌─────────────┐
│  Actividad  │  Acción o tarea a realizar
└─────────────┘

    ◇───────◇
  ╱           ╲
 ╱  Decisión   ╲   Punto de decisión (branch)
 ╲             ╱
   ╲         ╱
    ◇───────◇

════════════════
║    FORK     ║   División en flujos paralelos
════════════════

════════════════
║    JOIN     ║   Sincronización de flujos paralelos
════════════════

════════════════
║    LOOP     ║   Iteración sobre elementos
════════════════

    │
    │───────────>   Flujo de control / transición
    │

    │
    │- - - - - ->   Flujo de datos / mensaje
    │

    [condición]     Guarda de transición
```
