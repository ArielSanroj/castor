# Diagramas de Secuencia - CASTOR ELECCIONES

## 1. Autenticación de Usuario (Login)

```
┌───────┐          ┌───────┐          ┌───────────┐          ┌──────────┐          ┌───────┐
│Cliente│          │ Nginx │          │Core Service│          │PostgreSQL│          │ Redis │
└───┬───┘          └───┬───┘          └─────┬─────┘          └────┬─────┘          └───┬───┘
    │                  │                    │                     │                    │
    │ POST /api/auth/login                  │                     │                    │
    │ {email, password}                     │                     │                    │
    │─────────────────>│                    │                     │                    │
    │                  │                    │                     │                    │
    │                  │ Rate limit check   │                     │                    │
    │                  │ (5 req/s auth)     │                     │                    │
    │                  │───────────────────>│                     │                    │
    │                  │                    │                     │                    │
    │                  │                    │ SELECT user         │                    │
    │                  │                    │ WHERE email = ?     │                    │
    │                  │                    │────────────────────>│                    │
    │                  │                    │                     │                    │
    │                  │                    │      User data      │                    │
    │                  │                    │<────────────────────│                    │
    │                  │                    │                     │                    │
    │                  │                    │ verify_password()   │                    │
    │                  │                    │─────────┐           │                    │
    │                  │                    │         │ bcrypt    │                    │
    │                  │                    │<────────┘           │                    │
    │                  │                    │                     │                    │
    │                  │                    │ generate_jwt()      │                    │
    │                  │                    │─────────┐           │                    │
    │                  │                    │         │           │                    │
    │                  │                    │<────────┘           │                    │
    │                  │                    │                     │                    │
    │                  │                    │ SET session:{id}    │                    │
    │                  │                    │ TTL 3600            │                    │
    │                  │                    │───────────────────────────────────────────>│
    │                  │                    │                     │                    │
    │                  │                    │           OK        │                    │
    │                  │                    │<───────────────────────────────────────────│
    │                  │                    │                     │                    │
    │                  │  200 OK            │                     │                    │
    │                  │  {access_token,    │                     │                    │
    │                  │   refresh_token}   │                     │                    │
    │                  │<───────────────────│                     │                    │
    │                  │                    │                     │                    │
    │  200 OK          │                    │                     │                    │
    │  {access_token,  │                    │                     │                    │
    │   refresh_token} │                    │                     │                    │
    │<─────────────────│                    │                     │                    │
    │                  │                    │                     │                    │
```

---

## 2. Análisis de Campaña Electoral (Flujo Principal)

```
┌───────┐     ┌───────┐     ┌─────────┐     ┌───────┐     ┌────────┐     ┌──────┐     ┌───────┐
│Cliente│     │ Nginx │     │Dashboard│     │Twitter│     │Sentiment│     │OpenAI│     │  DB   │
│       │     │       │     │ Service │     │  API  │     │ (BETO) │     │GPT-4o│     │       │
└───┬───┘     └───┬───┘     └────┬────┘     └───┬───┘     └────┬───┘     └───┬──┘     └───┬───┘
    │             │              │              │              │             │            │
    │ POST /api/campaign/analyze │              │              │             │            │
    │ {location, topic,          │              │              │             │            │
    │  candidate}                │              │              │             │            │
    │────────────>│              │              │              │             │            │
    │             │              │              │              │             │            │
    │             │ Validate JWT │              │              │             │            │
    │             │──────────────>              │              │             │            │
    │             │              │              │              │             │            │
    │             │   JWT Valid  │              │              │             │            │
    │             │<─────────────│              │              │             │            │
    │             │              │              │              │             │            │
    │             │ Forward request             │              │             │            │
    │             │──────────────>              │              │             │            │
    │             │              │              │              │             │            │
    │             │              │ ┌──────────────────────────────────────────────────┐  │
    │             │              │ │ PASO 1: Detectar Trending Topics                 │  │
    │             │              │ └──────────────────────────────────────────────────┘  │
    │             │              │              │              │             │            │
    │             │              │ GET trends   │              │             │            │
    │             │              │ ?woeid=23424787             │             │            │
    │             │              │ (Colombia)   │              │             │            │
    │             │              │─────────────>│              │             │            │
    │             │              │              │              │             │            │
    │             │              │ trending[]   │              │             │            │
    │             │              │<─────────────│              │             │            │
    │             │              │              │              │             │            │
    │             │              │ ┌──────────────────────────────────────────────────┐  │
    │             │              │ │ PASO 2: Buscar Tweets por Tema PND               │  │
    │             │              │ └──────────────────────────────────────────────────┘  │
    │             │              │              │              │             │            │
    │             │              │ GET search   │              │             │            │
    │             │              │ ?q={topic}   │              │             │            │
    │             │              │ &geo={loc}   │              │             │            │
    │             │              │ &max=15      │              │             │            │
    │             │              │─────────────>│              │             │            │
    │             │              │              │              │             │            │
    │             │              │   tweets[]   │              │             │            │
    │             │              │<─────────────│              │             │            │
    │             │              │              │              │             │            │
    │             │              │ ┌──────────────────────────────────────────────────┐  │
    │             │              │ │ PASO 3: Análisis de Sentimiento (BETO)           │  │
    │             │              │ └──────────────────────────────────────────────────┘  │
    │             │              │              │              │             │            │
    │             │              │ analyze(tweets)             │             │            │
    │             │              │─────────────────────────────>             │            │
    │             │              │              │              │             │            │
    │             │              │              │   Tokenize   │             │            │
    │             │              │              │   ─────────┐ │             │            │
    │             │              │              │             │ │             │            │
    │             │              │              │   <─────────┘ │             │            │
    │             │              │              │              │             │            │
    │             │              │              │   BETO Model │             │            │
    │             │              │              │   Inference  │             │            │
    │             │              │              │   ─────────┐ │             │            │
    │             │              │              │             │ │             │            │
    │             │              │              │   <─────────┘ │             │            │
    │             │              │              │              │             │            │
    │             │              │ sentiments[] │              │             │            │
    │             │              │ {positive,   │              │             │            │
    │             │              │  negative,   │              │             │            │
    │             │              │  neutral}    │              │             │            │
    │             │              │<─────────────────────────────│             │            │
    │             │              │              │              │             │            │
    │             │              │ ┌──────────────────────────────────────────────────┐  │
    │             │              │ │ PASO 4: Clasificar por Tema PND                  │  │
    │             │              │ └──────────────────────────────────────────────────┘  │
    │             │              │              │              │             │            │
    │             │              │ classify_pnd()              │             │            │
    │             │              │───────────┐  │              │             │            │
    │             │              │           │  │              │             │            │
    │             │              │<──────────┘  │              │             │            │
    │             │              │              │              │             │            │
    │             │              │ ┌──────────────────────────────────────────────────┐  │
    │             │              │ │ PASO 5: Generar Contenido con GPT-4o             │  │
    │             │              │ └──────────────────────────────────────────────────┘  │
    │             │              │              │              │             │            │
    │             │              │ generate_summary(data)      │             │            │
    │             │              │──────────────────────────────────────────>│            │
    │             │              │              │              │             │            │
    │             │              │              │              │  executive  │            │
    │             │              │              │              │  summary    │            │
    │             │              │<──────────────────────────────────────────│            │
    │             │              │              │              │             │            │
    │             │              │ generate_strategy(data)     │             │            │
    │             │              │──────────────────────────────────────────>│            │
    │             │              │              │              │             │            │
    │             │              │              │              │  strategic  │            │
    │             │              │              │              │  plan       │            │
    │             │              │<──────────────────────────────────────────│            │
    │             │              │              │              │             │            │
    │             │              │ generate_speech(data)       │             │            │
    │             │              │──────────────────────────────────────────>│            │
    │             │              │              │              │             │            │
    │             │              │              │              │  speech     │            │
    │             │              │<──────────────────────────────────────────│            │
    │             │              │              │              │             │            │
    │             │              │ ┌──────────────────────────────────────────────────┐  │
    │             │              │ │ PASO 6: Guardar Análisis                         │  │
    │             │              │ └──────────────────────────────────────────────────┘  │
    │             │              │              │              │             │            │
    │             │              │ INSERT analysis                           │            │
    │             │              │───────────────────────────────────────────────────────>│
    │             │              │              │              │             │            │
    │             │              │              │              │             │   OK       │
    │             │              │<───────────────────────────────────────────────────────│
    │             │              │              │              │             │            │
    │             │  200 OK      │              │              │             │            │
    │             │  {summary,   │              │              │             │            │
    │             │   strategy,  │              │              │             │            │
    │             │   speech,    │              │              │             │            │
    │             │   charts,    │              │              │             │            │
    │             │   metrics}   │              │              │             │            │
    │             │<─────────────│              │              │             │            │
    │             │              │              │              │             │            │
    │  200 OK     │              │              │              │             │            │
    │  Response   │              │              │             │             │            │
    │<────────────│              │              │              │             │            │
    │             │              │              │              │             │            │
```

---

## 3. Procesamiento OCR de Formulario E-14

```
┌───────┐     ┌───────┐     ┌────────┐     ┌─────────┐     ┌──────────┐     ┌───────┐
│Cliente│     │ Nginx │     │  E-14  │     │Anthropic│     │Validation│     │  DB   │
│       │     │       │     │Service │     │ Claude  │     │ Service  │     │       │
└───┬───┘     └───┬───┘     └───┬────┘     └────┬────┘     └────┬─────┘     └───┬───┘
    │             │             │               │               │               │
    │ POST /api/e14/process     │               │               │               │
    │ {file: PDF/Image}         │               │               │               │
    │────────────>│             │               │               │               │
    │             │             │               │               │               │
    │             │ Forward     │               │               │               │
    │             │────────────>│               │               │               │
    │             │             │               │               │               │
    │             │             │ ┌───────────────────────────────────────────┐ │
    │             │             │ │ PASO 1: Validar Archivo                   │ │
    │             │             │ └───────────────────────────────────────────┘ │
    │             │             │               │               │               │
    │             │             │ validate_file()               │               │
    │             │             │ - size <= 10MB                │               │
    │             │             │ - pages <= 20                 │               │
    │             │             │ - format: PDF/PNG/JPG         │               │
    │             │             │───────┐      │               │               │
    │             │             │       │      │               │               │
    │             │             │<──────┘      │               │               │
    │             │             │               │               │               │
    │             │             │ ┌───────────────────────────────────────────┐ │
    │             │             │ │ PASO 2: Preprocesar Imagen                │ │
    │             │             │ └───────────────────────────────────────────┘ │
    │             │             │               │               │               │
    │             │             │ convert_to_images()           │               │
    │             │             │ (pdf2image, DPI=150)          │               │
    │             │             │───────┐      │               │               │
    │             │             │       │      │               │               │
    │             │             │<──────┘      │               │               │
    │             │             │               │               │               │
    │             │             │ ┌───────────────────────────────────────────┐ │
    │             │             │ │ PASO 3: OCR con Claude Vision             │ │
    │             │             │ └───────────────────────────────────────────┘ │
    │             │             │               │               │               │
    │             │             │ loop [for each page]          │               │
    │             │             │ ┌─────────────┼───────────────┼───────────┐   │
    │             │             │ │             │               │           │   │
    │             │             │ │ POST /messages               │           │   │
    │             │             │ │ model: claude-3-5-sonnet    │           │   │
    │             │             │ │ {image_base64,              │           │   │
    │             │             │ │  prompt: "Extract E-14..."}  │           │   │
    │             │             │ │────────────>│               │           │   │
    │             │             │ │             │               │           │   │
    │             │             │ │             │ Vision        │           │   │
    │             │             │ │             │ Processing    │           │   │
    │             │             │ │             │───────┐       │           │   │
    │             │             │ │             │       │       │           │   │
    │             │             │ │             │<──────┘       │           │   │
    │             │             │ │             │               │           │   │
    │             │             │ │ {cells: [], │               │           │   │
    │             │             │ │  confidence: 0.95}          │           │   │
    │             │             │ │<────────────│               │           │   │
    │             │             │ │             │               │           │   │
    │             │             │ └─────────────┼───────────────┼───────────┘   │
    │             │             │               │               │               │
    │             │             │ ┌───────────────────────────────────────────┐ │
    │             │             │ │ PASO 4: Extraer Datos de Votos            │ │
    │             │             │ └───────────────────────────────────────────┘ │
    │             │             │               │               │               │
    │             │             │ parse_vote_tallies()          │               │
    │             │             │───────┐      │               │               │
    │             │             │       │      │               │               │
    │             │             │<──────┘      │               │               │
    │             │             │               │               │               │
    │             │             │ ┌───────────────────────────────────────────┐ │
    │             │             │ │ PASO 5: Validación Aritmética             │ │
    │             │             │ └───────────────────────────────────────────┘ │
    │             │             │               │               │               │
    │             │             │ validate(vote_tallies)        │               │
    │             │             │──────────────────────────────>│               │
    │             │             │               │               │               │
    │             │             │               │  check_sums() │               │
    │             │             │               │  ───────────┐ │               │
    │             │             │               │             │ │               │
    │             │             │               │  <──────────┘ │               │
    │             │             │               │               │               │
    │             │             │               │  detect_      │               │
    │             │             │               │  discrepancies│               │
    │             │             │               │  ───────────┐ │               │
    │             │             │               │             │ │               │
    │             │             │               │  <──────────┘ │               │
    │             │             │               │               │               │
    │             │             │ {valid: bool, │               │               │
    │             │             │  discrepancies:[],            │               │
    │             │             │  alerts:[]}   │               │               │
    │             │             │<──────────────────────────────│               │
    │             │             │               │               │               │
    │             │             │ ┌───────────────────────────────────────────┐ │
    │             │             │ │ PASO 6: Crear Alertas si hay problemas    │ │
    │             │             │ └───────────────────────────────────────────┘ │
    │             │             │               │               │               │
    │             │             │ alt [discrepancies found]     │               │
    │             │             │ ┌─────────────┼───────────────┼───────────┐   │
    │             │             │ │             │               │           │   │
    │             │             │ │ create_alert(severity)      │           │   │
    │             │             │ │──────────────────────────────────────────>   │
    │             │             │ │             │               │           │   │
    │             │             │ │             │               │      OK   │   │
    │             │             │ │<──────────────────────────────────────────   │
    │             │             │ │             │               │           │   │
    │             │             │ └─────────────┼───────────────┼───────────┘   │
    │             │             │               │               │               │
    │             │             │ ┌───────────────────────────────────────────┐ │
    │             │             │ │ PASO 7: Guardar en Base de Datos          │ │
    │             │             │ └───────────────────────────────────────────┘ │
    │             │             │               │               │               │
    │             │             │ INSERT form_instance          │               │
    │             │             │───────────────────────────────────────────────>│
    │             │             │               │               │               │
    │             │             │ INSERT ocr_fields             │               │
    │             │             │───────────────────────────────────────────────>│
    │             │             │               │               │               │
    │             │             │ INSERT vote_tallies           │               │
    │             │             │───────────────────────────────────────────────>│
    │             │             │               │               │               │
    │             │             │ INSERT audit_log              │               │
    │             │             │───────────────────────────────────────────────>│
    │             │             │               │               │               │
    │             │             │               │               │          OK   │
    │             │             │<───────────────────────────────────────────────│
    │             │             │               │               │               │
    │             │  200 OK     │               │               │               │
    │             │  {form_id,  │               │               │               │
    │             │   status,   │               │               │               │
    │             │   votes,    │               │               │               │
    │             │   alerts}   │               │               │               │
    │             │<────────────│               │               │               │
    │             │             │               │               │               │
    │  200 OK     │             │               │               │               │
    │  Response   │             │               │               │               │
    │<────────────│             │               │               │               │
    │             │             │               │               │               │
```

---

## 4. Chat RAG (Retrieval-Augmented Generation)

```
┌───────┐     ┌───────┐     ┌─────────┐     ┌────────┐     ┌──────┐     ┌───────┐
│Cliente│     │ Nginx │     │Dashboard│     │ChromaDB│     │OpenAI│     │  DB   │
│       │     │       │     │ Service │     │        │     │      │     │       │
└───┬───┘     └───┬───┘     └────┬────┘     └───┬────┘     └───┬──┘     └───┬───┘
    │             │              │              │              │            │
    │ POST /api/chat/rag         │              │              │            │
    │ {query: "¿Qué opinan       │              │              │            │
    │  sobre educación?",        │              │              │            │
    │  session_id}               │              │              │            │
    │────────────>│              │              │              │            │
    │             │              │              │              │            │
    │             │ Forward      │              │              │            │
    │             │─────────────>│              │              │            │
    │             │              │              │              │            │
    │             │              │ ┌──────────────────────────────────────┐ │
    │             │              │ │ PASO 1: Obtener Historial            │ │
    │             │              │ └──────────────────────────────────────┘ │
    │             │              │              │              │            │
    │             │              │ SELECT chat_history          │            │
    │             │              │ WHERE session = ?            │            │
    │             │              │─────────────────────────────────────────>│
    │             │              │              │              │            │
    │             │              │        history[]            │            │
    │             │              │<─────────────────────────────────────────│
    │             │              │              │              │            │
    │             │              │ ┌──────────────────────────────────────┐ │
    │             │              │ │ PASO 2: Generar Embedding de Query   │ │
    │             │              │ └──────────────────────────────────────┘ │
    │             │              │              │              │            │
    │             │              │ POST /embeddings             │            │
    │             │              │ model: text-embedding-3-small            │
    │             │              │ input: query  │              │            │
    │             │              │─────────────────────────────>│            │
    │             │              │              │              │            │
    │             │              │        embedding[1536]      │            │
    │             │              │<─────────────────────────────│            │
    │             │              │              │              │            │
    │             │              │ ┌──────────────────────────────────────┐ │
    │             │              │ │ PASO 3: Búsqueda Semántica           │ │
    │             │              │ └──────────────────────────────────────┘ │
    │             │              │              │              │            │
    │             │              │ query(embedding,             │            │
    │             │              │        n_results=5)         │            │
    │             │              │─────────────>│              │            │
    │             │              │              │              │            │
    │             │              │              │  Cosine      │            │
    │             │              │              │  Similarity  │            │
    │             │              │              │──────┐       │            │
    │             │              │              │      │       │            │
    │             │              │              │<─────┘       │            │
    │             │              │              │              │            │
    │             │              │ relevant_docs[]             │            │
    │             │              │ (tweets, analyses)          │            │
    │             │              │<─────────────│              │            │
    │             │              │              │              │            │
    │             │              │ ┌──────────────────────────────────────┐ │
    │             │              │ │ PASO 4: Construir Contexto           │ │
    │             │              │ └──────────────────────────────────────┘ │
    │             │              │              │              │            │
    │             │              │ build_context()              │            │
    │             │              │ - relevant_docs              │            │
    │             │              │ - chat_history               │            │
    │             │              │───────┐      │              │            │
    │             │              │       │      │              │            │
    │             │              │<──────┘      │              │            │
    │             │              │              │              │            │
    │             │              │ ┌──────────────────────────────────────┐ │
    │             │              │ │ PASO 5: Generar Respuesta con GPT-4o │ │
    │             │              │ └──────────────────────────────────────┘ │
    │             │              │              │              │            │
    │             │              │ POST /chat/completions       │            │
    │             │              │ {system: "Eres asistente electoral...", │
    │             │              │  context: relevant_docs,    │            │
    │             │              │  history: chat_history,     │            │
    │             │              │  query: user_query}         │            │
    │             │              │─────────────────────────────>│            │
    │             │              │              │              │            │
    │             │              │              │   Streaming  │            │
    │             │              │              │   Response   │            │
    │             │              │              │──────┐       │            │
    │             │              │              │      │       │            │
    │             │              │              │<─────┘       │            │
    │             │              │              │              │            │
    │             │              │         response            │            │
    │             │              │<─────────────────────────────│            │
    │             │              │              │              │            │
    │             │              │ ┌──────────────────────────────────────┐ │
    │             │              │ │ PASO 6: Guardar en Historial         │ │
    │             │              │ └──────────────────────────────────────┘ │
    │             │              │              │              │            │
    │             │              │ INSERT chat_history          │            │
    │             │              │ (query, response, session)   │            │
    │             │              │─────────────────────────────────────────>│
    │             │              │              │              │            │
    │             │              │              │              │       OK   │
    │             │              │<─────────────────────────────────────────│
    │             │              │              │              │            │
    │             │  200 OK      │              │              │            │
    │             │  {response,  │              │              │            │
    │             │   sources}   │              │              │            │
    │             │<─────────────│              │              │            │
    │             │              │              │              │            │
    │  200 OK     │              │              │              │            │
    │  Response   │              │              │              │            │
    │<────────────│              │              │              │            │
    │             │              │              │              │            │
```

---

## 5. Pronóstico Electoral

```
┌───────┐     ┌───────┐     ┌─────────┐     ┌──────────┐     ┌───────┐
│Cliente│     │ Nginx │     │Dashboard│     │ Forecast │     │  DB   │
│       │     │       │     │ Service │     │ Service  │     │       │
└───┬───┘     └───┬───┘     └────┬────┘     └────┬─────┘     └───┬───┘
    │             │              │               │               │
    │ GET /api/forecast/predict  │               │               │
    │ ?candidate=X&days=14       │               │               │
    │────────────>│              │               │               │
    │             │              │               │               │
    │             │ Forward      │               │               │
    │             │─────────────>│               │               │
    │             │              │               │               │
    │             │              │ ┌───────────────────────────────────┐
    │             │              │ │ PASO 1: Obtener Datos Históricos  │
    │             │              │ └───────────────────────────────────┘
    │             │              │               │               │
    │             │              │ SELECT analyses               │
    │             │              │ WHERE candidate = ?           │
    │             │              │ ORDER BY date DESC            │
    │             │              │ LIMIT 90 days │               │
    │             │              │───────────────────────────────>│
    │             │              │               │               │
    │             │              │      historical_data[]        │
    │             │              │<───────────────────────────────│
    │             │              │               │               │
    │             │              │ ┌───────────────────────────────────┐
    │             │              │ │ PASO 2: Calcular Métricas Base    │
    │             │              │ └───────────────────────────────────┘
    │             │              │               │               │
    │             │              │ calculate_metrics()           │
    │             │              │──────────────>│               │
    │             │              │               │               │
    │             │              │               │ calc_isn()    │
    │             │              │               │ (Índice       │
    │             │              │               │  Sentimiento  │
    │             │              │               │  Neto)        │
    │             │              │               │───────┐       │
    │             │              │               │       │       │
    │             │              │               │<──────┘       │
    │             │              │               │               │
    │             │              │               │ calc_icr()    │
    │             │              │               │ (Índice       │
    │             │              │               │  Conversación │
    │             │              │               │  Relativa)    │
    │             │              │               │───────┐       │
    │             │              │               │       │       │
    │             │              │               │<──────┘       │
    │             │              │               │               │
    │             │              │               │ calc_momentum()
    │             │              │               │───────┐       │
    │             │              │               │       │       │
    │             │              │               │<──────┘       │
    │             │              │               │               │
    │             │              │ {isn, icr,    │               │
    │             │              │  momentum}    │               │
    │             │              │<──────────────│               │
    │             │              │               │               │
    │             │              │ ┌───────────────────────────────────┐
    │             │              │ │ PASO 3: Calcular ICCE             │
    │             │              │ └───────────────────────────────────┘
    │             │              │               │               │
    │             │              │ calculate_icce()              │
    │             │              │──────────────>│               │
    │             │              │               │               │
    │             │              │               │ ICCE =        │
    │             │              │               │ (ISN * 0.4) + │
    │             │              │               │ (ICR * 0.3) + │
    │             │              │               │ (Mom * 0.3)   │
    │             │              │               │───────┐       │
    │             │              │               │       │       │
    │             │              │               │<──────┘       │
    │             │              │               │               │
    │             │              │    icce: 0-100│               │
    │             │              │<──────────────│               │
    │             │              │               │               │
    │             │              │ ┌───────────────────────────────────┐
    │             │              │ │ PASO 4: Proyección Holt-Winters   │
    │             │              │ └───────────────────────────────────┘
    │             │              │               │               │
    │             │              │ holt_winters_forecast()       │
    │             │              │ (14 días)     │               │
    │             │              │──────────────>│               │
    │             │              │               │               │
    │             │              │               │ Triple        │
    │             │              │               │ Exponential   │
    │             │              │               │ Smoothing     │
    │             │              │               │───────┐       │
    │             │              │               │       │       │
    │             │              │               │<──────┘       │
    │             │              │               │               │
    │             │              │ forecast[]    │               │
    │             │              │ {date, value, │               │
    │             │              │  confidence}  │               │
    │             │              │<──────────────│               │
    │             │              │               │               │
    │             │              │ ┌───────────────────────────────────┐
    │             │              │ │ PASO 5: Calcular SVE e IVN        │
    │             │              │ └───────────────────────────────────┘
    │             │              │               │               │
    │             │              │ calculate_sve_ivn()           │
    │             │              │──────────────>│               │
    │             │              │               │               │
    │             │              │               │ SVE =         │
    │             │              │               │ Sentimiento   │
    │             │              │               │ Votante       │
    │             │              │               │ Esperado      │
    │             │              │               │───────┐       │
    │             │              │               │       │       │
    │             │              │               │<──────┘       │
    │             │              │               │               │
    │             │              │               │ IVN =         │
    │             │              │               │ Índice        │
    │             │              │               │ Votante Neto  │
    │             │              │               │───────┐       │
    │             │              │               │       │       │
    │             │              │               │<──────┘       │
    │             │              │               │               │
    │             │              │ {sve, ivn}    │               │
    │             │              │<──────────────│               │
    │             │              │               │               │
    │             │  200 OK      │               │               │
    │             │  {icce,      │               │               │
    │             │   isn,       │               │               │
    │             │   momentum,  │               │               │
    │             │   forecast,  │               │               │
    │             │   sve,       │               │               │
    │             │   ivn}       │               │               │
    │             │<─────────────│               │               │
    │             │              │               │               │
    │  200 OK     │              │               │               │
    │  Forecast   │              │               │               │
    │<────────────│              │               │               │
    │             │              │               │               │
```

---

## 6. Revisión Manual de Formulario (HITL - Human in the Loop)

```
┌───────┐     ┌───────┐     ┌────────┐     ┌──────────┐     ┌───────┐
│ Admin │     │ Nginx │     │  E-14  │     │  Audit   │     │  DB   │
│       │     │       │     │Service │     │ Service  │     │       │
└───┬───┘     └───┬───┘     └───┬────┘     └────┬─────┘     └───┬───┘
    │             │             │               │               │
    │ GET /api/review/pending   │               │               │
    │────────────>│             │               │               │
    │             │             │               │               │
    │             │────────────>│               │               │
    │             │             │               │               │
    │             │             │ SELECT forms  │               │
    │             │             │ WHERE status  │               │
    │             │             │ = 'NEEDS_REVIEW'              │
    │             │             │───────────────────────────────>│
    │             │             │               │               │
    │             │             │   forms[]     │               │
    │             │             │<───────────────────────────────│
    │             │             │               │               │
    │             │  forms[]    │               │               │
    │             │<────────────│               │               │
    │             │             │               │               │
    │  forms[]    │             │               │               │
    │<────────────│             │               │               │
    │             │             │               │               │
    │ ════════════════════════════════════════════════════════ │
    │             │             │               │               │
    │ POST /api/review/{id}/approve             │               │
    │ {corrections: [...],      │               │               │
    │  notes: "..."}            │               │               │
    │────────────>│             │               │               │
    │             │             │               │               │
    │             │────────────>│               │               │
    │             │             │               │               │
    │             │             │ ┌───────────────────────────────────┐
    │             │             │ │ Aplicar Correcciones              │
    │             │             │ └───────────────────────────────────┘
    │             │             │               │               │
    │             │             │ UPDATE vote_tallies           │
    │             │             │ SET value = corrected_value   │
    │             │             │───────────────────────────────>│
    │             │             │               │               │
    │             │             │ UPDATE form_instance          │
    │             │             │ SET status = 'VALIDATED'      │
    │             │             │───────────────────────────────>│
    │             │             │               │               │
    │             │             │ ┌───────────────────────────────────┐
    │             │             │ │ Registrar en Audit Log            │
    │             │             │ └───────────────────────────────────┘
    │             │             │               │               │
    │             │             │ log_action(   │               │
    │             │             │   'REVIEW_APPROVED',          │
    │             │             │   user_id,    │               │
    │             │             │   changes)    │               │
    │             │             │──────────────>│               │
    │             │             │               │               │
    │             │             │               │ INSERT        │
    │             │             │               │ audit_log     │
    │             │             │               │ (immutable)   │
    │             │             │               │───────────────>│
    │             │             │               │               │
    │             │             │               │          OK   │
    │             │             │               │<───────────────│
    │             │             │               │               │
    │             │             │      OK       │               │
    │             │             │<──────────────│               │
    │             │             │               │               │
    │             │             │ ┌───────────────────────────────────┐
    │             │             │ │ Resolver Alertas Relacionadas     │
    │             │             │ └───────────────────────────────────┘
    │             │             │               │               │
    │             │             │ UPDATE alerts │               │
    │             │             │ SET status = 'RESOLVED'       │
    │             │             │───────────────────────────────>│
    │             │             │               │               │
    │             │             │               │          OK   │
    │             │             │<───────────────────────────────│
    │             │             │               │               │
    │             │  200 OK     │               │               │
    │             │  {status:   │               │               │
    │             │   'approved'}               │               │
    │             │<────────────│               │               │
    │             │             │               │               │
    │  200 OK     │             │               │               │
    │<────────────│             │               │               │
    │             │             │               │               │
```

---

## Resumen de Interacciones

| Secuencia | Actores Principales | Operaciones Clave |
|-----------|--------------------|--------------------|
| **Login** | Cliente → Core → PostgreSQL → Redis | Validar credenciales, generar JWT, crear sesión |
| **Análisis Campaña** | Cliente → Dashboard → Twitter → BETO → OpenAI → DB | Trending, búsqueda tweets, sentiment, generación IA |
| **OCR E-14** | Cliente → E-14 → Claude → Validation → DB | Procesar PDF, OCR Vision, validar aritmética, alertas |
| **Chat RAG** | Cliente → Dashboard → ChromaDB → OpenAI → DB | Embedding, búsqueda semántica, generación respuesta |
| **Pronóstico** | Cliente → Dashboard → Forecast → DB | Métricas, ICCE, Holt-Winters, SVE/IVN |
| **Revisión HITL** | Admin → E-14 → Audit → DB | Correcciones manuales, audit log inmutable |
