# Diagrama de Componentes - CASTOR ELECCIONES

## 1. Vista General del Sistema

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                        ARQUITECTURA DE COMPONENTES                                   │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                      │
│                              <<subsystem>>                                           │
│                          CASTOR ELECCIONES                                           │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                         CAPA DE PRESENTACIÓN                                 │   │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐                    │   │
│  │  │   Web Client  │  │  Mobile App   │  │   Admin UI    │                    │   │
│  │  │   (Browser)   │  │   (Future)    │  │  (Dashboard)  │                    │   │
│  │  └───────┬───────┘  └───────┬───────┘  └───────┬───────┘                    │   │
│  └──────────┼──────────────────┼──────────────────┼────────────────────────────┘   │
│             │                  │                  │                                 │
│             └──────────────────┼──────────────────┘                                 │
│                                │                                                    │
│                                ▼                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                         CAPA DE API GATEWAY                                  │   │
│  │                                                                              │   │
│  │                    ┌─────────────────────────┐                               │   │
│  │                    │         NGINX           │                               │   │
│  │                    │    (Reverse Proxy)      │                               │   │
│  │                    │    - SSL Termination    │                               │   │
│  │                    │    - Rate Limiting      │                               │   │
│  │                    │    - Load Balancing     │                               │   │
│  │                    └────────────┬────────────┘                               │   │
│  └─────────────────────────────────┼────────────────────────────────────────────┘   │
│                                    │                                                │
│                    ┌───────────────┼───────────────┐                               │
│                    │               │               │                               │
│                    ▼               ▼               ▼                               │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                         CAPA DE MICROSERVICIOS                               │   │
│  │                                                                              │   │
│  │  ┌───────────────────┐ ┌───────────────────┐ ┌───────────────────┐          │   │
│  │  │   Core Service    │ │   E-14 Service    │ │ Dashboard Service │          │   │
│  │  │     (Auth)        │ │     (OCR)         │ │    (Analytics)    │          │   │
│  │  └─────────┬─────────┘ └─────────┬─────────┘ └─────────┬─────────┘          │   │
│  └────────────┼─────────────────────┼─────────────────────┼─────────────────────┘   │
│               │                     │                     │                         │
│               └─────────────────────┼─────────────────────┘                         │
│                                     │                                               │
│                                     ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                           CAPA DE DATOS                                      │   │
│  │                                                                              │   │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐                    │   │
│  │  │  PostgreSQL   │  │     Redis     │  │   ChromaDB    │                    │   │
│  │  │  (Persistent) │  │    (Cache)    │  │   (Vectors)   │                    │   │
│  │  └───────────────┘  └───────────────┘  └───────────────┘                    │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                      CAPA DE INTEGRACIÓN EXTERNA                             │   │
│  │                                                                              │   │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐                    │   │
│  │  │  Twitter API  │  │  OpenAI API   │  │ Anthropic API │                    │   │
│  │  └───────────────┘  └───────────────┘  └───────────────┘                    │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Core Service - Componentes

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              <<component>>                                           │
│                              CORE SERVICE                                            │
│                                Puerto: 5001                                          │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                      │
│    ○──┤ IAuthAPI          Interfaces Proporcionadas (Provided)                      │
│    ○──┤ IUserAPI                                                                    │
│    ○──┤ IHealthAPI                                                                  │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                                                                              │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│  │  │                      ROUTES LAYER                                    │    │   │
│  │  │                                                                      │    │   │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌───────────┐   │    │   │
│  │  │  │    auth     │  │    users    │  │    leads    │  │  health   │   │    │   │
│  │  │  │  Blueprint  │  │  Blueprint  │  │  Blueprint  │  │ Blueprint │   │    │   │
│  │  │  │             │  │             │  │             │  │           │   │    │   │
│  │  │  │ /login      │  │ /profile    │  │ /create     │  │ /status   │   │    │   │
│  │  │  │ /register   │  │ /update     │  │ /list       │  │ /ready    │   │    │   │
│  │  │  │ /logout     │  │ /delete     │  │ /assign     │  │           │   │    │   │
│  │  │  │ /refresh    │  │             │  │             │  │           │   │    │   │
│  │  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └───────────┘   │    │   │
│  │  │         │                │                │                          │    │   │
│  │  └─────────┼────────────────┼────────────────┼──────────────────────────┘    │   │
│  │            │                │                │                               │   │
│  │            ▼                ▼                ▼                               │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│  │  │                      SERVICE LAYER                                   │    │   │
│  │  │                                                                      │    │   │
│  │  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐      │    │   │
│  │  │  │  <<component>>  │  │  <<component>>  │  │  <<component>>  │      │    │   │
│  │  │  │   AuthService   │  │   UserService   │  │   LeadService   │      │    │   │
│  │  │  │                 │  │                 │  │                 │      │    │   │
│  │  │  │ +login()        │  │ +getById()      │  │ +create()       │      │    │   │
│  │  │  │ +register()     │  │ +getByEmail()   │  │ +getAll()       │      │    │   │
│  │  │  │ +logout()       │  │ +create()       │  │ +update()       │      │    │   │
│  │  │  │ +refresh()      │  │ +update()       │  │ +assign()       │      │    │   │
│  │  │  │ +validate()     │  │ +delete()       │  │ +changeStatus() │      │    │   │
│  │  │  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘      │    │   │
│  │  │           │                    │                    │               │    │   │
│  │  │           │    ┌───────────────┴───────────────┐    │               │    │   │
│  │  │           │    │                               │    │               │    │   │
│  │  │           ▼    ▼                               ▼    ▼               │    │   │
│  │  │  ┌─────────────────┐                 ┌─────────────────┐            │    │   │
│  │  │  │  <<component>>  │                 │  <<component>>  │            │    │   │
│  │  │  │  TokenService   │                 │ PasswordService │            │    │   │
│  │  │  │                 │                 │                 │            │    │   │
│  │  │  │ +generateJWT()  │                 │ +hash()         │            │    │   │
│  │  │  │ +verifyJWT()    │                 │ +verify()       │            │    │   │
│  │  │  │ +refreshToken() │                 │ +validate()     │            │    │   │
│  │  │  └─────────────────┘                 └─────────────────┘            │    │   │
│  │  │                                                                      │    │   │
│  │  └──────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                              │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│  │  │                       DATA LAYER                                     │    │   │
│  │  │                                                                      │    │   │
│  │  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐      │    │   │
│  │  │  │  <<component>>  │  │  <<component>>  │  │  <<component>>  │      │    │   │
│  │  │  │   UserModel     │  │  SessionModel   │  │   LeadModel     │      │    │   │
│  │  │  │  (SQLAlchemy)   │  │  (SQLAlchemy)   │  │  (SQLAlchemy)   │      │    │   │
│  │  │  └─────────────────┘  └─────────────────┘  └─────────────────┘      │    │   │
│  │  │                                                                      │    │   │
│  │  └──────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                              │   │
│  └──────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│    ┤──○ IDatabase         Interfaces Requeridas (Required)                          │
│    ┤──○ ICache                                                                      │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. E-14 Service - Componentes

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              <<component>>                                           │
│                              E-14 SERVICE                                            │
│                                Puerto: 5002                                          │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                      │
│    ○──┤ IFormAPI          Interfaces Proporcionadas                                 │
│    ○──┤ IPipelineAPI                                                                │
│    ○──┤ IReviewAPI                                                                  │
│    ○──┤ IAlertAPI                                                                   │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                                                                              │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│  │  │                      ROUTES LAYER                                    │    │   │
│  │  │                                                                      │    │   │
│  │  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐         │    │   │
│  │  │  │   e14     │  │ pipeline  │  │  review   │  │  alerts   │         │    │   │
│  │  │  │ Blueprint │  │ Blueprint │  │ Blueprint │  │ Blueprint │         │    │   │
│  │  │  │           │  │           │  │           │  │           │         │    │   │
│  │  │  │ /process  │  │ /ingest   │  │ /pending  │  │ /list     │         │    │   │
│  │  │  │ /validate │  │ /batch    │  │ /approve  │  │ /ack      │         │    │   │
│  │  │  │ /status   │  │ /status   │  │ /reject   │  │ /resolve  │         │    │   │
│  │  │  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘         │    │   │
│  │  │        │              │              │              │                │    │   │
│  │  └────────┼──────────────┼──────────────┼──────────────┼────────────────┘    │   │
│  │           │              │              │              │                     │   │
│  │           ▼              ▼              ▼              ▼                     │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│  │  │                      SERVICE LAYER                                   │    │   │
│  │  │                                                                      │    │   │
│  │  │  ┌─────────────────────────────────────────────────────────────┐    │    │   │
│  │  │  │                    OCR SUBSYSTEM                             │    │    │   │
│  │  │  │                                                              │    │    │   │
│  │  │  │  ┌─────────────────┐      ┌─────────────────┐               │    │    │   │
│  │  │  │  │  <<component>>  │      │  <<component>>  │               │    │    │   │
│  │  │  │  │  E14OCRService  │─────>│ ClaudeOCRAdapter│               │    │    │   │
│  │  │  │  │                 │      │                 │               │    │    │   │
│  │  │  │  │ +processForm()  │      │ +extractText()  │──┤──○ IAnthropicAPI
│  │  │  │  │ +parallelOCR()  │      │ +extractCells() │               │    │    │   │
│  │  │  │  │ +extractVotes() │      │ +getConfidence()│               │    │    │   │
│  │  │  │  └─────────────────┘      └─────────────────┘               │    │    │   │
│  │  │  │                                                              │    │    │   │
│  │  │  └──────────────────────────────────────────────────────────────┘    │    │   │
│  │  │                                                                      │    │   │
│  │  │  ┌─────────────────────────────────────────────────────────────┐    │    │   │
│  │  │  │                 VALIDATION SUBSYSTEM                         │    │    │   │
│  │  │  │                                                              │    │    │   │
│  │  │  │  ┌─────────────────┐      ┌─────────────────┐               │    │    │   │
│  │  │  │  │  <<component>>  │      │  <<component>>  │               │    │    │   │
│  │  │  │  │ValidationService│─────>│  AlertService   │               │    │    │   │
│  │  │  │  │                 │      │                 │               │    │    │   │
│  │  │  │  │ +validate()     │      │ +create()       │               │    │    │   │
│  │  │  │  │ +checkArith()   │      │ +acknowledge()  │               │    │    │   │
│  │  │  │  │ +detectDiscrep()│      │ +resolve()      │               │    │    │   │
│  │  │  │  └─────────────────┘      └─────────────────┘               │    │    │   │
│  │  │  │                                                              │    │    │   │
│  │  │  └──────────────────────────────────────────────────────────────┘    │    │   │
│  │  │                                                                      │    │   │
│  │  │  ┌─────────────────────────────────────────────────────────────┐    │    │   │
│  │  │  │               RECONCILIATION SUBSYSTEM                       │    │    │   │
│  │  │  │                                                              │    │    │   │
│  │  │  │  ┌─────────────────┐      ┌─────────────────┐               │    │    │   │
│  │  │  │  │  <<component>>  │      │  <<component>>  │               │    │    │   │
│  │  │  │  │ Reconciliation  │─────>│ AuditLogService │               │    │    │   │
│  │  │  │  │    Service      │      │                 │               │    │    │   │
│  │  │  │  │                 │      │ +log()          │               │    │    │   │
│  │  │  │  │ +reconcile()    │      │ +getByForm()    │               │    │    │   │
│  │  │  │  │ +selectWinner() │      │ +getByUser()    │               │    │    │   │
│  │  │  │  │ +finalize()     │      │ +export()       │               │    │    │   │
│  │  │  │  └─────────────────┘      └─────────────────┘               │    │    │   │
│  │  │  │                                                              │    │    │   │
│  │  │  └──────────────────────────────────────────────────────────────┘    │    │   │
│  │  │                                                                      │    │   │
│  │  │  ┌─────────────────┐                                                 │    │   │
│  │  │  │  <<component>>  │                                                 │    │   │
│  │  │  │IngestionPipeline│                                                 │    │   │
│  │  │  │                 │                                                 │    │   │
│  │  │  │ +ingest()       │                                                 │    │   │
│  │  │  │ +batchIngest()  │                                                 │    │   │
│  │  │  │ +getStatus()    │                                                 │    │   │
│  │  │  │ +retryFailed()  │                                                 │    │   │
│  │  │  └─────────────────┘                                                 │    │   │
│  │  │                                                                      │    │   │
│  │  └──────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                              │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│  │  │                       DATA LAYER                                     │    │   │
│  │  │                                                                      │    │   │
│  │  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │    │   │
│  │  │  │FormInstance│ │ OCRField  │ │ VoteTally │ │   Alert   │           │    │   │
│  │  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │    │   │
│  │  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │    │   │
│  │  │  │Discrepancy│ │Reconciliat│ │ AuditLog  │ │Validation │           │    │   │
│  │  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │    │   │
│  │  │                                                                      │    │   │
│  │  └──────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                              │   │
│  └──────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│    ┤──○ IDatabase         Interfaces Requeridas                                     │
│    ┤──○ ICache                                                                      │
│    ┤──○ IAnthropicAPI                                                               │
│    ┤──○ IFileStorage                                                                │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Dashboard Service - Componentes

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              <<component>>                                           │
│                            DASHBOARD SERVICE                                         │
│                                Puerto: 5003                                          │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                      │
│    ○──┤ IAnalysisAPI      Interfaces Proporcionadas                                 │
│    ○──┤ IChatAPI                                                                    │
│    ○──┤ IForecastAPI                                                                │
│    ○──┤ ICampaignAPI                                                                │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                                                                              │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│  │  │                      ROUTES LAYER                                    │    │   │
│  │  │                                                                      │    │   │
│  │  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐         │    │   │
│  │  │  │   media   │  │   chat    │  │ forecast  │  │ campaign  │         │    │   │
│  │  │  │ Blueprint │  │ Blueprint │  │ Blueprint │  │ Blueprint │         │    │   │
│  │  │  │           │  │           │  │           │  │           │         │    │   │
│  │  │  │ /analyze  │  │ /rag      │  │ /predict  │  │ /analyze  │         │    │   │
│  │  │  │ /history  │  │ /history  │  │ /metrics  │  │ /strategy │         │    │   │
│  │  │  │ /export   │  │ /clear    │  │ /trends   │  │ /speech   │         │    │   │
│  │  │  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘         │    │   │
│  │  │        │              │              │              │                │    │   │
│  │  └────────┼──────────────┼──────────────┼──────────────┼────────────────┘    │   │
│  │           │              │              │              │                     │   │
│  │           ▼              ▼              ▼              ▼                     │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│  │  │                      SERVICE LAYER                                   │    │   │
│  │  │                                                                      │    │   │
│  │  │  ┌─────────────────────────────────────────────────────────────┐    │    │   │
│  │  │  │                  TWITTER SUBSYSTEM                           │    │    │   │
│  │  │  │                                                              │    │    │   │
│  │  │  │  ┌─────────────────┐      ┌─────────────────┐               │    │    │   │
│  │  │  │  │  <<component>>  │      │  <<component>>  │               │    │    │   │
│  │  │  │  │ TwitterService  │─────>│ TrendingService │               │    │    │   │
│  │  │  │  │                 │      │                 │               │    │    │   │
│  │  │  │  │ +searchTweets() │      │ +getTrending()  │──┤──○ ITwitterAPI
│  │  │  │  │ +getTrending()  │      │ +detectTopics() │               │    │    │   │
│  │  │  │  │ +getUser()      │      │ +rankByRelevance│               │    │    │   │
│  │  │  │  └─────────────────┘      └─────────────────┘               │    │    │   │
│  │  │  │                                                              │    │    │   │
│  │  │  └──────────────────────────────────────────────────────────────┘    │    │   │
│  │  │                                                                      │    │   │
│  │  │  ┌─────────────────────────────────────────────────────────────┐    │    │   │
│  │  │  │                 SENTIMENT SUBSYSTEM                          │    │    │   │
│  │  │  │                                                              │    │    │   │
│  │  │  │  ┌─────────────────┐      ┌─────────────────┐               │    │    │   │
│  │  │  │  │  <<component>>  │      │  <<component>>  │               │    │    │   │
│  │  │  │  │SentimentService │─────>│BETOAnalyzer     │               │    │    │   │
│  │  │  │  │                 │      │                 │               │    │    │   │
│  │  │  │  │ +analyzeTweets()│      │ +analyze()      │               │    │    │   │
│  │  │  │  │ +getDistribut() │      │ +batchAnalyze() │               │    │    │   │
│  │  │  │  │ +calculateISN() │      │ +preprocess()   │               │    │    │   │
│  │  │  │  └─────────────────┘      └─────────────────┘               │    │    │   │
│  │  │  │           │                                                  │    │    │   │
│  │  │  │           ▼                                                  │    │    │   │
│  │  │  │  ┌─────────────────┐                                        │    │    │   │
│  │  │  │  │  <<component>>  │                                        │    │    │   │
│  │  │  │  │TopicClassifier  │                                        │    │    │   │
│  │  │  │  │    Service      │                                        │    │    │   │
│  │  │  │  │                 │                                        │    │    │   │
│  │  │  │  │ +classify()     │                                        │    │    │   │
│  │  │  │  │ +getPNDDistrib()│                                        │    │    │   │
│  │  │  │  └─────────────────┘                                        │    │    │   │
│  │  │  │                                                              │    │    │   │
│  │  │  └──────────────────────────────────────────────────────────────┘    │    │   │
│  │  │                                                                      │    │   │
│  │  │  ┌─────────────────────────────────────────────────────────────┐    │    │   │
│  │  │  │                    AI SUBSYSTEM                              │    │    │   │
│  │  │  │                                                              │    │    │   │
│  │  │  │  ┌─────────────────┐      ┌─────────────────┐               │    │    │   │
│  │  │  │  │  <<component>>  │      │  <<component>>  │               │    │    │   │
│  │  │  │  │  OpenAIService  │─────>│  OpenAIAdapter  │               │    │    │   │
│  │  │  │  │                 │      │                 │               │    │    │   │
│  │  │  │  │ +genSummary()   │      │ +generate()     │──┤──○ IOpenAIAPI
│  │  │  │  │ +genStrategy()  │      │ +chat()         │               │    │    │   │
│  │  │  │  │ +genSpeech()    │      │ +embed()        │               │    │    │   │
│  │  │  │  └─────────────────┘      └─────────────────┘               │    │    │   │
│  │  │  │           │                                                  │    │    │   │
│  │  │  │           ▼                                                  │    │    │   │
│  │  │  │  ┌─────────────────┐      ┌─────────────────┐               │    │    │   │
│  │  │  │  │  <<component>>  │      │  <<component>>  │               │    │    │   │
│  │  │  │  │   RAGService    │─────>│   ChromaDB      │               │    │    │   │
│  │  │  │  │                 │      │   Adapter       │               │    │    │   │
│  │  │  │  │ +indexDocs()    │      │                 │──┤──○ IVectorDB
│  │  │  │  │ +search()       │      │ +add()          │               │    │    │   │
│  │  │  │  │ +chat()         │      │ +query()        │               │    │    │   │
│  │  │  │  └─────────────────┘      └─────────────────┘               │    │    │   │
│  │  │  │                                                              │    │    │   │
│  │  │  └──────────────────────────────────────────────────────────────┘    │    │   │
│  │  │                                                                      │    │   │
│  │  │  ┌─────────────────────────────────────────────────────────────┐    │    │   │
│  │  │  │                 FORECAST SUBSYSTEM                           │    │    │   │
│  │  │  │                                                              │    │    │   │
│  │  │  │  ┌─────────────────┐      ┌─────────────────┐               │    │    │   │
│  │  │  │  │  <<component>>  │      │  <<component>>  │               │    │    │   │
│  │  │  │  │ForecastService  │─────>│CampaignAgent    │               │    │    │   │
│  │  │  │  │                 │      │    Service      │               │    │    │   │
│  │  │  │  │ +predict()      │      │                 │               │    │    │   │
│  │  │  │  │ +calcICCE()     │      │ +analyze()      │               │    │    │   │
│  │  │  │  │ +calcMomentum() │      │ +getRecommend() │               │    │    │   │
│  │  │  │  │ +holtWinters()  │      │ +optimizeMsg()  │               │    │    │   │
│  │  │  │  └─────────────────┘      └─────────────────┘               │    │    │   │
│  │  │  │                                                              │    │    │   │
│  │  │  └──────────────────────────────────────────────────────────────┘    │    │   │
│  │  │                                                                      │    │   │
│  │  └──────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                              │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│  │  │                       DATA LAYER                                     │    │   │
│  │  │                                                                      │    │   │
│  │  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │    │   │
│  │  │  │ Analysis  │ │   Tweet   │ │ChatSession│ │ Forecast  │           │    │   │
│  │  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │    │   │
│  │  │  ┌───────────┐ ┌───────────┐ ┌───────────┐                         │    │   │
│  │  │  │ChatMessage│ │RAGDocument│ │CampaignAgt│                         │    │   │
│  │  │  └───────────┘ └───────────┘ └───────────┘                         │    │   │
│  │  │                                                                      │    │   │
│  │  └──────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                              │   │
│  └──────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│    ┤──○ IDatabase         Interfaces Requeridas                                     │
│    ┤──○ ICache                                                                      │
│    ┤──○ ITwitterAPI                                                                 │
│    ┤──○ IOpenAIAPI                                                                  │
│    ┤──○ IVectorDB                                                                   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. Componentes de Infraestructura

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                         COMPONENTES DE INFRAESTRUCTURA                               │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                           API GATEWAY                                        │   │
│  │                                                                              │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│  │  │                     <<component>>                                    │    │   │
│  │  │                        NGINX                                         │    │   │
│  │  │                                                                      │    │   │
│  │  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐           │    │   │
│  │  │  │  SSL/TLS      │  │ Rate Limiter  │  │ Load Balancer │           │    │   │
│  │  │  │  Termination  │  │               │  │               │           │    │   │
│  │  │  │               │  │ 10 req/s gen  │  │ Round Robin   │           │    │   │
│  │  │  │ TLSv1.2+      │  │ 5 req/s auth  │  │ Upstream pool │           │    │   │
│  │  │  └───────────────┘  └───────────────┘  └───────────────┘           │    │   │
│  │  │                                                                      │    │   │
│  │  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐           │    │   │
│  │  │  │ CORS Handler  │  │  Gzip Comp    │  │ Security Hdrs │           │    │   │
│  │  │  │               │  │               │  │               │           │    │   │
│  │  │  │ Origins list  │  │ level: 6      │  │ HSTS, CSP     │           │    │   │
│  │  │  │ Methods       │  │ min size 1K   │  │ X-Frame-Opt   │           │    │   │
│  │  │  └───────────────┘  └───────────────┘  └───────────────┘           │    │   │
│  │  │                                                                      │    │   │
│  │  └──────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                           DATA STORES                                        │   │
│  │                                                                              │   │
│  │  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐  │   │
│  │  │    <<component>>    │  │    <<component>>    │  │    <<component>>    │  │   │
│  │  │     PostgreSQL      │  │       Redis         │  │      ChromaDB       │  │   │
│  │  │                     │  │                     │  │                     │  │   │
│  │  │  ┌───────────────┐  │  │  ┌───────────────┐  │  │  ┌───────────────┐  │  │   │
│  │  │  │   core_db     │  │  │  │    DB 0       │  │  │  │  Collections  │  │  │   │
│  │  │  │   - users     │  │  │  │  Core cache   │  │  │  │  - tweets     │  │  │   │
│  │  │  │   - sessions  │  │  │  │  Sessions     │  │  │  │  - analyses   │  │  │   │
│  │  │  └───────────────┘  │  │  └───────────────┘  │  │  └───────────────┘  │  │   │
│  │  │  ┌───────────────┐  │  │  ┌───────────────┐  │  │                     │  │   │
│  │  │  │   e14_db      │  │  │  │    DB 1       │  │  │  Embeddings:        │  │   │
│  │  │  │   - forms     │  │  │  │  E-14 cache   │  │  │  text-embedding-   │  │   │
│  │  │  │   - votes     │  │  │  │  OCR results  │  │  │  3-small           │  │   │
│  │  │  │   - alerts    │  │  │  └───────────────┘  │  │  (1536 dims)       │  │   │
│  │  │  └───────────────┘  │  │  ┌───────────────┐  │  │                     │  │   │
│  │  │  ┌───────────────┐  │  │  │    DB 2       │  │  │                     │  │   │
│  │  │  │ dashboard_db  │  │  │  │  Dashboard    │  │  │                     │  │   │
│  │  │  │   - analyses  │  │  │  │  - Twitter    │  │  │                     │  │   │
│  │  │  │   - tweets    │  │  │  │  - Sentiment  │  │  │                     │  │   │
│  │  │  │   - chats     │  │  │  │  - OpenAI     │  │  │                     │  │   │
│  │  │  └───────────────┘  │  │  └───────────────┘  │  │                     │  │   │
│  │  │                     │  │                     │  │                     │  │   │
│  │  │  Puerto: 5432       │  │  Puerto: 6379       │  │  Puerto: 8000       │  │   │
│  │  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘  │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Componentes Compartidos (Shared)

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            COMPONENTES COMPARTIDOS                                   │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                 <<package>>                                          │
│                                   shared                                             │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                            CONFIGURATION                                     │   │
│  │                                                                              │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │   │
│  │  │  <<component>>  │  │  <<component>>  │  │  <<component>>  │             │   │
│  │  │     Config      │  │   Environment   │  │    Secrets      │             │   │
│  │  │                 │  │                 │  │                 │             │   │
│  │  │ +loadFromEnv()  │  │ FLASK_ENV      │  │ +getAPIKey()    │             │   │
│  │  │ +validate()     │  │ DATABASE_URL   │  │ +getJWTSecret() │             │   │
│  │  │ +getConfig()    │  │ REDIS_URL      │  │ +rotate()       │             │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘             │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                              DATABASE                                        │   │
│  │                                                                              │   │
│  │  ┌─────────────────┐  ┌─────────────────┐                                   │   │
│  │  │  <<component>>  │  │  <<component>>  │                                   │   │
│  │  │DatabaseService  │  │  BaseModel      │                                   │   │
│  │  │                 │  │  (SQLAlchemy)   │                                   │   │
│  │  │ +getSession()   │  │                 │                                   │   │
│  │  │ +execute()      │  │ +save()         │                                   │   │
│  │  │ +commit()       │  │ +delete()       │                                   │   │
│  │  │ +rollback()     │  │ +toDict()       │                                   │   │
│  │  └─────────────────┘  └─────────────────┘                                   │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                               CACHING                                        │   │
│  │                                                                              │   │
│  │  ┌─────────────────┐  ┌─────────────────┐                                   │   │
│  │  │  <<component>>  │  │  <<component>>  │                                   │   │
│  │  │  CacheService   │  │  CacheConfig    │                                   │   │
│  │  │                 │  │                 │                                   │   │
│  │  │ +get()          │  │ TWITTER_TTL     │                                   │   │
│  │  │ +set()          │  │ SENTIMENT_TTL   │                                   │   │
│  │  │ +delete()       │  │ OPENAI_TTL      │                                   │   │
│  │  │ +exists()       │  │ TRENDING_TTL    │                                   │   │
│  │  └─────────────────┘  └─────────────────┘                                   │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                              RESILIENCE                                      │   │
│  │                                                                              │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │   │
│  │  │  <<component>>  │  │  <<component>>  │  │  <<component>>  │             │   │
│  │  │ CircuitBreaker  │  │  RateLimiter    │  │   HTTPClient    │             │   │
│  │  │                 │  │                 │  │                 │             │   │
│  │  │ +call()         │  │ +check()        │  │ +get()          │             │   │
│  │  │ +isOpen()       │  │ +increment()    │  │ +post()         │             │   │
│  │  │ +recordFailure()│  │ +reset()        │  │ +put()          │             │   │
│  │  │ +reset()        │  │ +getRemaining() │  │ +delete()       │             │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘             │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                              UTILITIES                                       │   │
│  │                                                                              │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │   │
│  │  │  <<component>>  │  │  <<component>>  │  │  <<component>>  │             │   │
│  │  │    Logger       │  │   Validators    │  │   Formatters    │             │   │
│  │  │                 │  │                 │  │                 │             │   │
│  │  │ +info()         │  │ +validateEmail()│  │ +formatDate()   │             │   │
│  │  │ +error()        │  │ +validateUUID() │  │ +formatJSON()   │             │   │
│  │  │ +warning()      │  │ +validateFile() │  │ +formatNumber() │             │   │
│  │  │ +debug()        │  │                 │  │                 │             │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘             │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                             EXCEPTIONS                                       │   │
│  │                                                                              │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │   │
│  │  │  <<component>>  │  │  <<component>>  │  │  <<component>>  │             │   │
│  │  │ AppException    │  │ValidationError │  │  APIError       │             │   │
│  │  │                 │  │                 │  │                 │             │   │
│  │  │ +message        │  │ +field          │  │ +statusCode     │             │   │
│  │  │ +code           │  │ +message        │  │ +message        │             │   │
│  │  │ +details        │  │ +value          │  │ +details        │             │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘             │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Diagrama de Dependencias entre Componentes

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                         DEPENDENCIAS ENTRE COMPONENTES                               │
└─────────────────────────────────────────────────────────────────────────────────────┘

                                ┌─────────────────┐
                                │   Web Client    │
                                │    (Browser)    │
                                └────────┬────────┘
                                         │
                                         │ HTTPS
                                         ▼
                                ┌─────────────────┐
                                │      NGINX      │
                                │  (API Gateway)  │
                                └────────┬────────┘
                                         │
                    ┌────────────────────┼────────────────────┐
                    │                    │                    │
                    ▼                    ▼                    ▼
           ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
           │  Core Service   │  │  E-14 Service   │  │Dashboard Service│
           │                 │  │                 │  │                 │
           │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │
           │ │ AuthService │ │  │ │E14OCRService│ │  │ │TwitterService│ │
           │ └─────────────┘ │  │ └──────┬──────┘ │  │ └──────┬──────┘ │
           │ ┌─────────────┐ │  │        │        │  │        │        │
           │ │ UserService │ │  │        ▼        │  │        ▼        │
           │ └─────────────┘ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │
           │ ┌─────────────┐ │  │ │ Validation  │ │  │ │ Sentiment   │ │
           │ │TokenService │ │  │ │  Service    │ │  │ │  Service    │ │
           │ └─────────────┘ │  │ └──────┬──────┘ │  │ └──────┬──────┘ │
           └────────┬────────┘  │        │        │  │        │        │
                    │           │        ▼        │  │        ▼        │
                    │           │ ┌─────────────┐ │  │ ┌─────────────┐ │
                    │           │ │AlertService │ │  │ │ RAGService  │ │
                    │           │ └─────────────┘ │  │ └─────────────┘ │
                    │           └────────┬────────┘  └────────┬────────┘
                    │                    │                    │
                    └────────────────────┼────────────────────┘
                                         │
                    ┌────────────────────┼────────────────────┐
                    │                    │                    │
                    ▼                    ▼                    ▼
           ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
           │   PostgreSQL    │  │     Redis       │  │    ChromaDB     │
           │                 │  │                 │  │                 │
           │  - core_db      │  │  - Sessions     │  │  - Embeddings   │
           │  - e14_db       │  │  - Cache        │  │  - Documents    │
           │  - dashboard_db │  │  - Rate limits  │  │                 │
           └─────────────────┘  └─────────────────┘  └─────────────────┘

                                         │
                                         │
                    ┌────────────────────┼────────────────────┐
                    │                    │                    │
                    ▼                    ▼                    ▼
           ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
           │   Twitter API   │  │   OpenAI API    │  │  Anthropic API  │
           │                 │  │                 │  │                 │
           │  - Search       │  │  - GPT-4o       │  │  - Claude 3.5   │
           │  - Trending     │  │  - Embeddings   │  │  - Vision OCR   │
           └─────────────────┘  └─────────────────┘  └─────────────────┘
```

---

## 8. Interfaces del Sistema

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              INTERFACES DEL SISTEMA                                  │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           INTERFACES PROPORCIONADAS                                  │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────┐
│     <<interface>>           │
│       IAuthAPI              │
├─────────────────────────────┤
│ POST /api/auth/login        │
│ POST /api/auth/register     │
│ POST /api/auth/logout       │
│ POST /api/auth/refresh      │
│ GET  /api/auth/validate     │
└─────────────────────────────┘

┌─────────────────────────────┐
│     <<interface>>           │
│       IFormAPI              │
├─────────────────────────────┤
│ POST /api/e14/process       │
│ GET  /api/e14/status/{id}   │
│ POST /api/e14/validate      │
│ GET  /api/e14/results/{id}  │
└─────────────────────────────┘

┌─────────────────────────────┐
│     <<interface>>           │
│      IAnalysisAPI           │
├─────────────────────────────┤
│ POST /api/campaign/analyze  │
│ GET  /api/campaign/history  │
│ GET  /api/campaign/{id}     │
│ POST /api/chat/rag          │
│ GET  /api/forecast/predict  │
└─────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            INTERFACES REQUERIDAS                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────┐  ┌─────────────────────────────┐
│     <<interface>>           │  │     <<interface>>           │
│      IDatabase              │  │       ICache                │
├─────────────────────────────┤  ├─────────────────────────────┤
│ +connect(): Connection      │  │ +get(key): Any              │
│ +execute(query): Result     │  │ +set(key, value, ttl): void │
│ +commit(): void             │  │ +delete(key): void          │
│ +rollback(): void           │  │ +exists(key): bool          │
│ +close(): void              │  │ +expire(key, ttl): void     │
└─────────────────────────────┘  └─────────────────────────────┘

┌─────────────────────────────┐  ┌─────────────────────────────┐
│     <<interface>>           │  │     <<interface>>           │
│      ITwitterAPI            │  │      IOpenAIAPI             │
├─────────────────────────────┤  ├─────────────────────────────┤
│ +searchTweets(q): List      │  │ +complete(prompt): str      │
│ +getTrending(woeid): List   │  │ +chat(messages): str        │
│ +getUser(id): User          │  │ +embed(text): List[float]   │
└─────────────────────────────┘  └─────────────────────────────┘

┌─────────────────────────────┐  ┌─────────────────────────────┐
│     <<interface>>           │  │     <<interface>>           │
│     IAnthropicAPI           │  │      IVectorDB              │
├─────────────────────────────┤  ├─────────────────────────────┤
│ +messages(prompt): str      │  │ +add(docs, embeddings): void│
│ +vision(image): dict        │  │ +query(embedding, k): List  │
└─────────────────────────────┘  │ +delete(ids): void          │
                                 └─────────────────────────────┘
```

---

## 9. Matriz de Componentes y Responsabilidades

| Componente | Servicio | Responsabilidad | Dependencias |
|------------|----------|-----------------|--------------|
| **AuthService** | Core | Autenticación JWT, login/logout | TokenService, UserService, Redis |
| **UserService** | Core | CRUD de usuarios | PostgreSQL |
| **TokenService** | Core | Generación/validación JWT | Config |
| **E14OCRService** | E-14 | Procesamiento OCR de formularios | ClaudeOCRAdapter, ValidationService |
| **ValidationService** | E-14 | Validación aritmética | AlertService |
| **AlertService** | E-14 | Gestión de alertas | PostgreSQL |
| **ReconciliationService** | E-14 | Reconciliación de votos | AuditLogService |
| **AuditLogService** | E-14 | Log inmutable de acciones | PostgreSQL |
| **TwitterService** | Dashboard | Búsqueda de tweets | Twitter API, Redis |
| **SentimentService** | Dashboard | Análisis de sentimiento | BETOAnalyzer |
| **OpenAIService** | Dashboard | Generación de contenido | OpenAI API, Redis |
| **RAGService** | Dashboard | Chat con retrieval | ChromaDB, OpenAI |
| **ForecastService** | Dashboard | Pronósticos electorales | PostgreSQL |
| **CampaignAgentService** | Dashboard | Análisis automático | SentimentService, OpenAIService |

---

## 10. Resumen de Componentes

| Capa | Cantidad | Componentes Principales |
|------|----------|------------------------|
| **API Gateway** | 1 | NGINX (SSL, Rate Limit, Load Balance) |
| **Core Service** | 5 | AuthService, UserService, TokenService, PasswordService, LeadService |
| **E-14 Service** | 8 | E14OCRService, ValidationService, AlertService, ReconciliationService, AuditLogService, IngestionPipeline, ClaudeOCRAdapter |
| **Dashboard Service** | 10 | TwitterService, TrendingService, SentimentService, BETOAnalyzer, TopicClassifierService, OpenAIService, RAGService, ForecastService, CampaignAgentService |
| **Shared** | 10 | Config, DatabaseService, CacheService, CircuitBreaker, RateLimiter, HTTPClient, Logger, Validators, Formatters, Exceptions |
| **Data Stores** | 3 | PostgreSQL, Redis, ChromaDB |
| **External APIs** | 3 | Twitter API, OpenAI API, Anthropic API |

**Total: ~40 componentes**
