# Diagrama de Paquetes - CASTOR ELECCIONES

## 1. Vista General de Paquetes

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              ESTRUCTURA DE PAQUETES                                  │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                      │
│                                 <<subsystem>>                                        │
│                                    castor                                            │
│                                                                                      │
│  ┌───────────────────────────────────────────────────────────────────────────────┐  │
│  │                                                                               │  │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐               │  │
│  │  │   <<package>>   │  │   <<package>>   │  │   <<package>>   │               │  │
│  │  │                 │  │                 │  │                 │               │  │
│  │  │  core_service   │  │  e14_service    │  │dashboard_service│               │  │
│  │  │                 │  │                 │  │                 │               │  │
│  │  │  Puerto: 5001   │  │  Puerto: 5002   │  │  Puerto: 5003   │               │  │
│  │  │                 │  │                 │  │                 │               │  │
│  │  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘               │  │
│  │           │                    │                    │                         │  │
│  │           └────────────────────┼────────────────────┘                         │  │
│  │                                │                                              │  │
│  │                                ▼                                              │  │
│  │                    ┌─────────────────────┐                                    │  │
│  │                    │     <<package>>     │                                    │  │
│  │                    │                     │                                    │  │
│  │                    │       shared        │                                    │  │
│  │                    │                     │                                    │  │
│  │                    │  (Componentes       │                                    │  │
│  │                    │   compartidos)      │                                    │  │
│  │                    │                     │                                    │  │
│  │                    └─────────────────────┘                                    │  │
│  │                                                                               │  │
│  └───────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                      │
│  ┌───────────────────────────────────────────────────────────────────────────────┐  │
│  │                                                                               │  │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐               │  │
│  │  │   <<package>>   │  │   <<package>>   │  │   <<package>>   │               │  │
│  │  │                 │  │                 │  │                 │               │  │
│  │  │   static        │  │   templates     │  │   migrations    │               │  │
│  │  │                 │  │                 │  │                 │               │  │
│  │  │  (CSS, JS)      │  │  (HTML/Jinja2)  │  │  (SQL Scripts)  │               │  │
│  │  │                 │  │                 │  │                 │               │  │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘               │  │
│  │                                                                               │  │
│  └───────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Core Service - Estructura de Paquetes

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                  <<package>>                                         │
│                                 core_service                                         │
│                                                                                      │
│                              services/core/                                          │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                              <<package>>                                     │   │
│  │                                 app                                          │   │
│  │                                                                              │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │   │
│  │  │   <<package>>   │  │   <<package>>   │  │   <<package>>   │             │   │
│  │  │     routes      │  │     models      │  │    schemas      │             │   │
│  │  │                 │  │                 │  │                 │             │   │
│  │  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │             │   │
│  │  │ │ __init__.py │ │  │ │ __init__.py │ │  │ │ __init__.py │ │             │   │
│  │  │ │ auth.py     │ │  │ │ user.py     │ │  │ │ auth.py     │ │             │   │
│  │  │ │ users.py    │ │  │ │ session.py  │ │  │ │ user.py     │ │             │   │
│  │  │ │ leads.py    │ │  │ │ lead.py     │ │  │ │ lead.py     │ │             │   │
│  │  │ │ health.py   │ │  │ │ base.py     │ │  │ │ common.py   │ │             │   │
│  │  │ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────┘ │             │   │
│  │  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘             │   │
│  │           │                    │                    │                       │   │
│  │           │    <<import>>      │    <<import>>      │                       │   │
│  │           └────────────────────┼────────────────────┘                       │   │
│  │                                │                                            │   │
│  │                                ▼                                            │   │
│  │           ┌─────────────────────────────────────────┐                       │   │
│  │           │            <<package>>                  │                       │   │
│  │           │             services                    │                       │   │
│  │           │                                         │                       │   │
│  │           │  ┌─────────────┐  ┌─────────────┐      │                       │   │
│  │           │  │ __init__.py │  │ auth.py     │      │                       │   │
│  │           │  │ user.py     │  │ token.py    │      │                       │   │
│  │           │  │ lead.py     │  │ password.py │      │                       │   │
│  │           │  └─────────────┘  └─────────────┘      │                       │   │
│  │           │                                         │                       │   │
│  │           └─────────────────────────────────────────┘                       │   │
│  │                                                                              │   │
│  │  ┌─────────────┐                                                            │   │
│  │  │ __init__.py │  Application Factory (create_app)                          │   │
│  │  └─────────────┘                                                            │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                              <<package>>                                     │   │
│  │                                utils                                         │   │
│  │                                                                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │   │
│  │  │ __init__.py │  │decorators.py│  │validators.py│  │ helpers.py  │        │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                                 │
│  │  main.py    │  │  config.py  │  │requirements │                                 │
│  │             │  │             │  │   .txt      │                                 │
│  │ Entry point │  │ Settings    │  │ Dependencies│                                 │
│  └─────────────┘  └─────────────┘  └─────────────┘                                 │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘


══════════════════════════════════════════════════════════════════════════════════════
                              ÁRBOL DE DIRECTORIOS
══════════════════════════════════════════════════════════════════════════════════════

services/core/
├── app/
│   ├── __init__.py          # Application Factory
│   ├── routes/
│   │   ├── __init__.py      # Blueprint registration
│   │   ├── auth.py          # /api/auth/*
│   │   ├── users.py         # /api/users/*
│   │   ├── leads.py         # /api/leads/*
│   │   └── health.py        # /api/health
│   ├── models/
│   │   ├── __init__.py
│   │   ├── base.py          # BaseModel (SQLAlchemy)
│   │   ├── user.py          # User model
│   │   ├── session.py       # Session model
│   │   └── lead.py          # Lead model
│   ├── schemas/
│   │   ├── __init__.py
│   │   ├── auth.py          # LoginRequest, TokenResponse
│   │   ├── user.py          # UserCreate, UserResponse
│   │   └── lead.py          # LeadCreate, LeadResponse
│   └── services/
│       ├── __init__.py
│       ├── auth.py          # AuthService
│       ├── user.py          # UserService
│       ├── token.py         # TokenService (JWT)
│       ├── password.py      # PasswordService (bcrypt)
│       └── lead.py          # LeadService
├── utils/
│   ├── __init__.py
│   ├── decorators.py        # @jwt_required, @admin_required
│   ├── validators.py        # Email, password validation
│   └── helpers.py           # Utility functions
├── main.py                  # Entry point
├── config.py                # Configuration
├── Dockerfile
└── requirements.txt
```

---

## 3. E-14 Service - Estructura de Paquetes

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                  <<package>>                                         │
│                                 e14_service                                          │
│                                                                                      │
│                            services/e14-service/                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                              <<package>>                                     │   │
│  │                                 app                                          │   │
│  │                                                                              │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │   │
│  │  │   <<package>>   │  │   <<package>>   │  │   <<package>>   │             │   │
│  │  │     routes      │  │     models      │  │    schemas      │             │   │
│  │  │                 │  │                 │  │                 │             │   │
│  │  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │             │   │
│  │  │ │ __init__.py │ │  │ │ __init__.py │ │  │ │ __init__.py │ │             │   │
│  │  │ │ e14.py      │ │  │ │ election.py │ │  │ │ form.py     │ │             │   │
│  │  │ │ pipeline.py │ │  │ │ geography.py│ │  │ │ vote.py     │ │             │   │
│  │  │ │ review.py   │ │  │ │ form.py     │ │  │ │ alert.py    │ │             │   │
│  │  │ │ alerts.py   │ │  │ │ vote.py     │ │  │ │ review.py   │ │             │   │
│  │  │ │ health.py   │ │  │ │ alert.py    │ │  │ └─────────────┘ │             │   │
│  │  │ └─────────────┘ │  │ │ audit.py    │ │  └─────────────────┘             │   │
│  │  └────────┬────────┘  │ │ reconcile.py│ │                                   │   │
│  │           │           │ └─────────────┘ │                                   │   │
│  │           │           └────────┬────────┘                                   │   │
│  │           │                    │                                            │   │
│  │           └────────────────────┼────────────────────────────────────────┐   │   │
│  │                                │                                        │   │   │
│  │                                ▼                                        │   │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │   │   │
│  │  │                       <<package>>                                │   │   │   │
│  │  │                        services                                  │   │   │   │
│  │  │                                                                  │   │   │   │
│  │  │  ┌───────────────────────────────────────────────────────────┐  │   │   │   │
│  │  │  │                   <<package>>                              │  │   │   │   │
│  │  │  │                      ocr                                   │  │   │   │   │
│  │  │  │                                                            │  │   │   │   │
│  │  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │  │   │   │   │
│  │  │  │  │ __init__.py │  │ service.py  │  │ adapter.py  │        │  │   │   │   │
│  │  │  │  │             │  │ E14OCR      │  │ ClaudeOCR   │        │  │   │   │   │
│  │  │  │  │             │  │ Service     │  │ Adapter     │        │  │   │   │   │
│  │  │  │  └─────────────┘  └─────────────┘  └─────────────┘        │  │   │   │   │
│  │  │  │                                                            │  │   │   │   │
│  │  │  └────────────────────────────────────────────────────────────┘  │   │   │   │
│  │  │                                                                  │   │   │   │
│  │  │  ┌───────────────────────────────────────────────────────────┐  │   │   │   │
│  │  │  │                   <<package>>                              │  │   │   │   │
│  │  │  │                   validation                               │  │   │   │   │
│  │  │  │                                                            │  │   │   │   │
│  │  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │  │   │   │   │
│  │  │  │  │ __init__.py │  │ service.py  │  │  rules.py   │        │  │   │   │   │
│  │  │  │  │             │  │ Validation  │  │ Validation  │        │  │   │   │   │
│  │  │  │  │             │  │ Service     │  │ Rules       │        │  │   │   │   │
│  │  │  │  └─────────────┘  └─────────────┘  └─────────────┘        │  │   │   │   │
│  │  │  │                                                            │  │   │   │   │
│  │  │  └────────────────────────────────────────────────────────────┘  │   │   │   │
│  │  │                                                                  │   │   │   │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │   │   │   │
│  │  │  │ alert.py    │  │reconcile.py │  │ audit.py    │              │   │   │   │
│  │  │  │ AlertService│  │Reconciliat. │  │ AuditLog    │              │   │   │   │
│  │  │  │             │  │Service      │  │ Service     │              │   │   │   │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘              │   │   │   │
│  │  │                                                                  │   │   │   │
│  │  │  ┌─────────────┐                                                 │   │   │   │
│  │  │  │ pipeline.py │  IngestionPipeline                              │   │   │   │
│  │  │  └─────────────┘                                                 │   │   │   │
│  │  │                                                                  │   │   │   │
│  │  └──────────────────────────────────────────────────────────────────┘   │   │   │
│  │                                                                          │   │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │   │
│                                                                                  │   │
│  ┌─────────────────────────────────────────────────────────────────────────────┐│   │
│  │                              <<package>>                                     ││   │
│  │                               migrations                                     ││   │
│  │                                                                              ││   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                         ││   │
│  │  │001_initial  │  │002_electoral│  │003_witness  │                         ││   │
│  │  │  .sql       │  │  .sql       │  │  .sql       │                         ││   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                         ││   │
│  │                                                                              ││   │
│  └─────────────────────────────────────────────────────────────────────────────┘│   │
│                                                                                  │   │
│  ┌─────────────────────────────────────────────────────────────────────────────┐│   │
│  │                              <<package>>                                     ││   │
│  │                                utils                                         ││   │
│  │                                                                              ││   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        ││   │
│  │  │rate_limiter │  │file_handler │  │ validators  │  │ formatters  │        ││   │
│  │  │   .py       │  │   .py       │  │   .py       │  │   .py       │        ││   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        ││   │
│  │                                                                              ││   │
│  └─────────────────────────────────────────────────────────────────────────────┘│   │
│                                                                                  │   │
└──────────────────────────────────────────────────────────────────────────────────┘   │


══════════════════════════════════════════════════════════════════════════════════════
                              ÁRBOL DE DIRECTORIOS
══════════════════════════════════════════════════════════════════════════════════════

services/e14-service/
├── app/
│   ├── __init__.py
│   ├── routes/
│   │   ├── __init__.py
│   │   ├── e14.py           # /api/e14/*
│   │   ├── pipeline.py      # /api/pipeline/*
│   │   ├── review.py        # /api/review/*
│   │   ├── alerts.py        # /api/alerts/*
│   │   └── health.py
│   ├── models/
│   │   ├── __init__.py
│   │   ├── election.py      # Election, Contest, Candidate, Party
│   │   ├── geography.py     # Department, Municipality, Station, Table
│   │   ├── form.py          # FormInstance, OCRField
│   │   ├── vote.py          # VoteTally
│   │   ├── alert.py         # Alert, Discrepancy
│   │   ├── audit.py         # AuditLog
│   │   └── reconcile.py     # Reconciliation
│   ├── schemas/
│   │   ├── __init__.py
│   │   ├── form.py
│   │   ├── vote.py
│   │   ├── alert.py
│   │   └── review.py
│   └── services/
│       ├── __init__.py
│       ├── ocr/
│       │   ├── __init__.py
│       │   ├── service.py   # E14OCRService
│       │   └── adapter.py   # ClaudeOCRAdapter
│       ├── validation/
│       │   ├── __init__.py
│       │   ├── service.py   # ValidationService
│       │   └── rules.py     # ValidationRules
│       ├── alert.py         # AlertService
│       ├── reconcile.py     # ReconciliationService
│       ├── audit.py         # AuditLogService
│       └── pipeline.py      # IngestionPipeline
├── migrations/
│   ├── 001_initial_schema.sql
│   ├── 002_electoral_schema.sql
│   └── 003_witness_schema.sql
├── utils/
│   ├── __init__.py
│   ├── rate_limiter.py
│   ├── file_handler.py
│   ├── validators.py
│   └── formatters.py
├── main.py
├── config.py
├── Dockerfile
└── requirements.txt
```

---

## 4. Dashboard Service - Estructura de Paquetes

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                  <<package>>                                         │
│                               dashboard_service                                      │
│                                                                                      │
│                           services/dashboard-ia/                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                              <<package>>                                     │   │
│  │                                 app                                          │   │
│  │                                                                              │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │   │
│  │  │   <<package>>   │  │   <<package>>   │  │   <<package>>   │             │   │
│  │  │     routes      │  │     models      │  │    schemas      │             │   │
│  │  │                 │  │                 │  │                 │             │   │
│  │  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │             │   │
│  │  │ │ __init__.py │ │  │ │ __init__.py │ │  │ │ __init__.py │ │             │   │
│  │  │ │ media.py    │ │  │ │ analysis.py │ │  │ │ core.py     │ │             │   │
│  │  │ │ chat.py     │ │  │ │ tweet.py    │ │  │ │ rag.py      │ │             │   │
│  │  │ │ forecast.py │ │  │ │ chat.py     │ │  │ │ analysis.py │ │             │   │
│  │  │ │ campaign.py │ │  │ │ forecast.py │ │  │ │ forecast.py │ │             │   │
│  │  │ │ health.py   │ │  │ │ rag.py      │ │  │ └─────────────┘ │             │   │
│  │  │ └─────────────┘ │  │ │ agent.py    │ │  └─────────────────┘             │   │
│  │  └────────┬────────┘  │ └─────────────┘ │                                   │   │
│  │           │           └────────┬────────┘                                   │   │
│  │           │                    │                                            │   │
│  │           └────────────────────┼─────────────────────────────────────────┐  │   │
│  │                                │                                         │  │   │
│  │                                ▼                                         │  │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐│  │   │
│  │  │                        <<package>>                                   ││  │   │
│  │  │                         services                                     ││  │   │
│  │  │                                                                      ││  │   │
│  │  │  ┌───────────────────────────────────────────────────────────────┐  ││  │   │
│  │  │  │                    <<package>>                                 │  ││  │   │
│  │  │  │                     twitter                                    │  ││  │   │
│  │  │  │                                                                │  ││  │   │
│  │  │  │  ┌─────────────┐  ┌─────────────┐                             │  ││  │   │
│  │  │  │  │ service.py  │  │ trending.py │                             │  ││  │   │
│  │  │  │  │ Twitter     │  │ Trending    │                             │  ││  │   │
│  │  │  │  │ Service     │  │ Service     │                             │  ││  │   │
│  │  │  │  └─────────────┘  └─────────────┘                             │  ││  │   │
│  │  │  │                                                                │  ││  │   │
│  │  │  └────────────────────────────────────────────────────────────────┘  ││  │   │
│  │  │                                                                      ││  │   │
│  │  │  ┌───────────────────────────────────────────────────────────────┐  ││  │   │
│  │  │  │                    <<package>>                                 │  ││  │   │
│  │  │  │                    sentiment                                   │  ││  │   │
│  │  │  │                                                                │  ││  │   │
│  │  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │  ││  │   │
│  │  │  │  │ service.py  │  │ analyzer.py │  │classifier.py│            │  ││  │   │
│  │  │  │  │ Sentiment   │  │ BETO        │  │ Topic       │            │  ││  │   │
│  │  │  │  │ Service     │  │ Analyzer    │  │ Classifier  │            │  ││  │   │
│  │  │  │  └─────────────┘  └─────────────┘  └─────────────┘            │  ││  │   │
│  │  │  │                                                                │  ││  │   │
│  │  │  └────────────────────────────────────────────────────────────────┘  ││  │   │
│  │  │                                                                      ││  │   │
│  │  │  ┌───────────────────────────────────────────────────────────────┐  ││  │   │
│  │  │  │                    <<package>>                                 │  ││  │   │
│  │  │  │                       ai                                       │  ││  │   │
│  │  │  │                                                                │  ││  │   │
│  │  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │  ││  │   │
│  │  │  │  │ openai.py   │  │  rag.py     │  │ adapters/   │            │  ││  │   │
│  │  │  │  │ OpenAI      │  │  RAG        │  │ ┌─────────┐ │            │  ││  │   │
│  │  │  │  │ Service     │  │  Service    │  │ │openai.py│ │            │  ││  │   │
│  │  │  │  └─────────────┘  └─────────────┘  │ │claude.py│ │            │  ││  │   │
│  │  │  │                                    │ └─────────┘ │            │  ││  │   │
│  │  │  │                                    └─────────────┘            │  ││  │   │
│  │  │  │                                                                │  ││  │   │
│  │  │  └────────────────────────────────────────────────────────────────┘  ││  │   │
│  │  │                                                                      ││  │   │
│  │  │  ┌───────────────────────────────────────────────────────────────┐  ││  │   │
│  │  │  │                    <<package>>                                 │  ││  │   │
│  │  │  │                    forecast                                    │  ││  │   │
│  │  │  │                                                                │  ││  │   │
│  │  │  │  ┌─────────────┐  ┌─────────────┐                             │  ││  │   │
│  │  │  │  │ service.py  │  │  agent.py   │                             │  ││  │   │
│  │  │  │  │ Forecast    │  │ Campaign    │                             │  ││  │   │
│  │  │  │  │ Service     │  │ Agent       │                             │  ││  │   │
│  │  │  │  └─────────────┘  └─────────────┘                             │  ││  │   │
│  │  │  │                                                                │  ││  │   │
│  │  │  └────────────────────────────────────────────────────────────────┘  ││  │   │
│  │  │                                                                      ││  │   │
│  │  └──────────────────────────────────────────────────────────────────────┘│  │   │
│  │                                                                          │  │   │
│  └──────────────────────────────────────────────────────────────────────────┘  │   │
│                                                                                 │   │
│  ┌─────────────────────────────────────────────────────────────────────────────┐│   │
│  │                              <<package>>                                     ││   │
│  │                                utils                                         ││   │
│  │                                                                              ││   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐     ││   │
│  │  │rate_limit │ │circuit_   │ │http_client│ │formatters │ │validators │     ││   │
│  │  │  er.py    │ │breaker.py │ │   .py     │ │   .py     │ │   .py     │     ││   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘ └───────────┘     ││   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐                                  ││   │
│  │  │ metrics   │ │audit_     │ │response_  │                                  ││   │
│  │  │   .py     │ │logger.py  │ │helpers.py │                                  ││   │
│  │  └───────────┘ └───────────┘ └───────────┘                                  ││   │
│  │                                                                              ││   │
│  └─────────────────────────────────────────────────────────────────────────────┘│   │
│                                                                                  │   │
└──────────────────────────────────────────────────────────────────────────────────┘   │


══════════════════════════════════════════════════════════════════════════════════════
                              ÁRBOL DE DIRECTORIOS
══════════════════════════════════════════════════════════════════════════════════════

services/dashboard-ia/
├── app/
│   ├── __init__.py
│   ├── routes/
│   │   ├── __init__.py
│   │   ├── media.py         # /api/media/*
│   │   ├── chat.py          # /api/chat/*
│   │   ├── forecast.py      # /api/forecast/*
│   │   ├── campaign.py      # /api/campaign/*
│   │   └── health.py
│   ├── models/
│   │   ├── __init__.py
│   │   ├── analysis.py      # Analysis
│   │   ├── tweet.py         # Tweet
│   │   ├── chat.py          # ChatSession, ChatMessage
│   │   ├── forecast.py      # Forecast
│   │   ├── rag.py           # RAGDocument
│   │   └── agent.py         # CampaignAgent
│   ├── schemas/
│   │   ├── __init__.py
│   │   ├── core.py
│   │   ├── rag.py
│   │   ├── analysis.py
│   │   └── forecast.py
│   └── services/
│       ├── __init__.py
│       ├── twitter/
│       │   ├── __init__.py
│       │   ├── service.py   # TwitterService
│       │   └── trending.py  # TrendingService
│       ├── sentiment/
│       │   ├── __init__.py
│       │   ├── service.py   # SentimentService
│       │   ├── analyzer.py  # BETOAnalyzer
│       │   └── classifier.py # TopicClassifier
│       ├── ai/
│       │   ├── __init__.py
│       │   ├── openai.py    # OpenAIService
│       │   ├── rag.py       # RAGService
│       │   └── adapters/
│       │       ├── __init__.py
│       │       ├── openai.py
│       │       └── claude.py
│       └── forecast/
│           ├── __init__.py
│           ├── service.py   # ForecastService
│           └── agent.py     # CampaignAgentService
├── utils/
│   ├── __init__.py
│   ├── rate_limiter.py
│   ├── circuit_breaker.py
│   ├── http_client.py
│   ├── formatters.py
│   ├── validators.py
│   ├── metrics.py
│   ├── audit_logger.py
│   └── response_helpers.py
├── main.py
├── config.py
├── Dockerfile
└── requirements.txt
```

---

## 5. Shared Package - Estructura

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                  <<package>>                                         │
│                                   shared                                             │
│                                                                                      │
│                              (Componentes Comunes)                                   │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                              <<package>>                                     │   │
│  │                                config                                        │   │
│  │                                                                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                         │   │
│  │  │ __init__.py │  │ settings.py │  │ constants.py│                         │   │
│  │  │             │  │             │  │             │                         │   │
│  │  │             │  │ - SECRET_KEY│  │ - CACHE_TTL │                         │   │
│  │  │             │  │ - DB_URL    │  │ - LIMITS    │                         │   │
│  │  │             │  │ - REDIS_URL │  │ - ENUMS     │                         │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                         │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                              <<package>>                                     │   │
│  │                               database                                       │   │
│  │                                                                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                         │   │
│  │  │ __init__.py │  │ service.py  │  │ base.py     │                         │   │
│  │  │             │  │ Database    │  │ BaseModel   │                         │   │
│  │  │             │  │ Service     │  │ (SQLAlchemy)│                         │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                         │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                              <<package>>                                     │   │
│  │                                cache                                         │   │
│  │                                                                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                         │   │
│  │  │ __init__.py │  │ service.py  │  │ config.py   │                         │   │
│  │  │             │  │ Cache       │  │ TTL config  │                         │   │
│  │  │             │  │ Service     │  │             │                         │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                         │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                              <<package>>                                     │   │
│  │                              resilience                                      │   │
│  │                                                                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                         │   │
│  │  │ __init__.py │  │circuit_     │  │rate_limiter │                         │   │
│  │  │             │  │breaker.py   │  │   .py       │                         │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                         │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                              <<package>>                                     │   │
│  │                                http                                          │   │
│  │                                                                              │   │
│  │  ┌─────────────┐  ┌─────────────┐                                          │   │
│  │  │ __init__.py │  │ client.py   │                                          │   │
│  │  │             │  │ HTTPClient  │                                          │   │
│  │  └─────────────┘  └─────────────┘                                          │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                              <<package>>                                     │   │
│  │                              exceptions                                      │   │
│  │                                                                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                         │   │
│  │  │ __init__.py │  │ base.py     │  │ handlers.py │                         │   │
│  │  │             │  │ AppException│  │ Error       │                         │   │
│  │  │             │  │ APIError    │  │ Handlers    │                         │   │
│  │  │             │  │ Validation  │  │             │                         │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                         │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                              <<package>>                                     │   │
│  │                                utils                                         │   │
│  │                                                                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │   │
│  │  │ __init__.py │  │ logger.py   │  │validators.py│  │formatters.py│        │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Static y Templates - Estructura

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                               FRONTEND PACKAGES                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                  <<package>>                                         │
│                                   static                                             │
│                                                                                      │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                     │
│  │   <<package>>   │  │   <<package>>   │  │   <<package>>   │                     │
│  │      css        │  │       js        │  │      data       │                     │
│  │                 │  │                 │  │                 │                     │
│  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │                     │
│  │ │ styles.css  │ │  │ │ main.js     │ │  │ │ colombia.json│                     │
│  │ │ dashboard   │ │  │ │ campaign_   │ │  │ │ divipola.json│                     │
│  │ │   .css      │ │  │ │ team.js     │ │  │ └─────────────┘ │                     │
│  │ │ witness.css │ │  │ │ witness.js  │ │  │                 │                     │
│  │ └─────────────┘ │  │ │ charts.js   │ │  │                 │                     │
│  │                 │  │ └─────────────┘ │  │                 │                     │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                     │
│                                                                                      │
│  ┌─────────────────┐  ┌─────────────────┐                                          │
│  │  manifest.json  │  │     sw.js       │   (PWA Support)                          │
│  └─────────────────┘  └─────────────────┘                                          │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                  <<package>>                                         │
│                                  templates                                           │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                            Jinja2 Templates                                  │   │
│  │                                                                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │   │
│  │  │ base.html   │  │ webpage.html│  │campaign.html│  │forecast.html│        │   │
│  │  │ (Layout)    │  │ (Portal)    │  │ (Dashboard) │  │(Predicciones)        │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │   │
│  │                                                                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │   │
│  │  │campaign_team│  │ unified_    │  │ analytics_  │  │  media.html │        │   │
│  │  │_dashboard   │  │ dashboard   │  │ dashboard   │  │             │        │   │
│  │  │  .html      │  │  .html      │  │  .html      │  │             │        │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │   │
│  │                                                                              │   │
│  │  ┌─────────────┐                                                            │   │
│  │  │ witness_    │                                                            │   │
│  │  │ register    │                                                            │   │
│  │  │  .html      │                                                            │   │
│  │  └─────────────┘                                                            │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Diagrama de Dependencias entre Paquetes

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                         DEPENDENCIAS ENTRE PAQUETES                                  │
└─────────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │    templates    │
                              │    (Jinja2)     │
                              └────────┬────────┘
                                       │
                                       │ renders
                                       ▼
                              ┌─────────────────┐
                              │     static      │
                              │   (CSS/JS)      │
                              └────────┬────────┘
                                       │
                                       │ served by
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                      │
│                              APPLICATION LAYER                                       │
│                                                                                      │
│     ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│     │  core_service   │    │   e14_service   │    │dashboard_service│              │
│     │                 │    │                 │    │                 │              │
│     │ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │              │
│     │ │   routes    │ │    │ │   routes    │ │    │ │   routes    │ │              │
│     │ └──────┬──────┘ │    │ └──────┬──────┘ │    │ └──────┬──────┘ │              │
│     │        │        │    │        │        │    │        │        │              │
│     │        ▼        │    │        ▼        │    │        ▼        │              │
│     │ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │              │
│     │ │  services   │ │    │ │  services   │ │    │ │  services   │ │              │
│     │ └──────┬──────┘ │    │ └──────┬──────┘ │    │ └──────┬──────┘ │              │
│     │        │        │    │        │        │    │        │        │              │
│     │        ▼        │    │        ▼        │    │        ▼        │              │
│     │ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │              │
│     │ │   models    │ │    │ │   models    │ │    │ │   models    │ │              │
│     │ └──────┬──────┘ │    │ └──────┬──────┘ │    │ └──────┬──────┘ │              │
│     │        │        │    │        │        │    │        │        │              │
│     │        ▼        │    │        ▼        │    │        ▼        │              │
│     │ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │              │
│     │ │   schemas   │ │    │ │   schemas   │ │    │ │   schemas   │ │              │
│     │ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │              │
│     │        │        │    │        │        │    │        │        │              │
│     │        ▼        │    │        ▼        │    │        ▼        │              │
│     │ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │              │
│     │ │    utils    │ │    │ │    utils    │ │    │ │    utils    │ │              │
│     │ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │              │
│     │                 │    │                 │    │                 │              │
│     └────────┬────────┘    └────────┬────────┘    └────────┬────────┘              │
│              │                      │                      │                        │
│              └──────────────────────┼──────────────────────┘                        │
│                                     │                                               │
│                                     │ <<import>>                                    │
│                                     ▼                                               │
│                          ┌─────────────────────┐                                    │
│                          │       shared        │                                    │
│                          │                     │                                    │
│                          │ ┌─────────────────┐ │                                    │
│                          │ │     config      │ │                                    │
│                          │ ├─────────────────┤ │                                    │
│                          │ │    database     │ │                                    │
│                          │ ├─────────────────┤ │                                    │
│                          │ │     cache       │ │                                    │
│                          │ ├─────────────────┤ │                                    │
│                          │ │   resilience    │ │                                    │
│                          │ ├─────────────────┤ │                                    │
│                          │ │      http       │ │                                    │
│                          │ ├─────────────────┤ │                                    │
│                          │ │   exceptions    │ │                                    │
│                          │ ├─────────────────┤ │                                    │
│                          │ │     utils       │ │                                    │
│                          │ └─────────────────┘ │                                    │
│                          │                     │                                    │
│                          └──────────┬──────────┘                                    │
│                                     │                                               │
└─────────────────────────────────────┼───────────────────────────────────────────────┘
                                      │
                                      │ <<import>>
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              EXTERNAL PACKAGES                                       │
│                                                                                      │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │
│  │   flask     │ │ sqlalchemy  │ │   redis     │ │   pydantic  │ │   tweepy    │  │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │
│                                                                                      │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │
│  │   openai    │ │  anthropic  │ │transformers │ │  chromadb   │ │   bcrypt    │  │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │
│                                                                                      │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                                   │
│  │  pdf2image  │ │   Pillow    │ │   PyJWT     │                                   │
│  └─────────────┘ └─────────────┘ └─────────────┘                                   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Matriz de Dependencias de Paquetes

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          MATRIZ DE DEPENDENCIAS                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘

                    │ shared │ core  │ e14   │ dash  │ static│templates
────────────────────┼────────┼───────┼───────┼───────┼───────┼─────────
shared              │   -    │   ✗   │   ✗   │   ✗   │   ✗   │   ✗
core_service        │   ✓    │   -   │   ✗   │   ✗   │   ✗   │   ✗
e14_service         │   ✓    │   ✗   │   -   │   ✗   │   ✗   │   ✗
dashboard_service   │   ✓    │   ✗   │   ✗   │   -   │   ✗   │   ✗
static              │   ✗    │   ✗   │   ✗   │   ✗   │   -   │   ✗
templates           │   ✗    │   ✗   │   ✗   │   ✗   │   ✓   │   -

Leyenda:
  ✓ = depende de
  ✗ = no depende de
  - = mismo paquete
```

---

## 9. Visibilidad y Acceso

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            VISIBILIDAD DE PAQUETES                                   │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                      │
│  PÚBLICO (Exportado via __init__.py)                                                │
│  ═══════════════════════════════════                                                │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │  shared/                                                                     │   │
│  │  ├── config          → Settings, get_config()                               │   │
│  │  ├── database        → DatabaseService, BaseModel                           │   │
│  │  ├── cache           → CacheService                                         │   │
│  │  ├── resilience      → CircuitBreaker, RateLimiter                          │   │
│  │  ├── http            → HTTPClient                                           │   │
│  │  ├── exceptions      → AppException, APIError, ValidationError              │   │
│  │  └── utils           → Logger, Validators, Formatters                       │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │  core_service/                                                               │   │
│  │  ├── app             → create_app()                                         │   │
│  │  ├── routes          → auth_bp, users_bp, leads_bp, health_bp               │   │
│  │  ├── models          → User, Session, Lead                                  │   │
│  │  ├── schemas         → LoginRequest, UserResponse, etc.                     │   │
│  │  └── services        → AuthService, UserService, TokenService               │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │  e14_service/                                                                │   │
│  │  ├── app             → create_app()                                         │   │
│  │  ├── routes          → e14_bp, pipeline_bp, review_bp, alerts_bp            │   │
│  │  ├── models          → FormInstance, VoteTally, Alert, AuditLog             │   │
│  │  ├── schemas         → FormRequest, VoteResponse, AlertResponse             │   │
│  │  └── services        → E14OCRService, ValidationService, AlertService       │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │  dashboard_service/                                                          │   │
│  │  ├── app             → create_app()                                         │   │
│  │  ├── routes          → media_bp, chat_bp, forecast_bp, campaign_bp          │   │
│  │  ├── models          → Analysis, Tweet, ChatSession, Forecast               │   │
│  │  ├── schemas         → AnalysisRequest, ChatRequest, ForecastResponse       │   │
│  │  └── services        → TwitterService, SentimentService, RAGService         │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                      │
│  PRIVADO (Uso interno del paquete)                                                  │
│  ══════════════════════════════════                                                 │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │  Prefijo _underscore para elementos privados:                                │   │
│  │                                                                              │   │
│  │  services/                                                                   │   │
│  │  ├── _helpers.py         # Funciones auxiliares internas                    │   │
│  │  ├── _constants.py       # Constantes internas                              │   │
│  │  └── service.py                                                              │   │
│  │      ├── _private_method()   # Método privado                               │   │
│  │      └── public_method()     # Método público                               │   │
│  │                                                                              │   │
│  │  Ejemplo:                                                                    │   │
│  │  class AuthService:                                                          │   │
│  │      def login(self, ...):           # Público                              │   │
│  │      def _hash_password(self, ...):  # Privado                              │   │
│  │      def _verify_token(self, ...):   # Privado                              │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 10. Resumen de Paquetes

| Paquete | Sub-paquetes | Módulos | Propósito |
|---------|--------------|---------|-----------|
| **core_service** | 5 | 20+ | Autenticación, usuarios, sesiones |
| **e14_service** | 6 | 30+ | OCR, validación, alertas, auditoría |
| **dashboard_service** | 7 | 35+ | Twitter, sentiment, IA, pronósticos |
| **shared** | 7 | 15+ | Componentes reutilizables |
| **static** | 3 | 10+ | CSS, JavaScript, datos |
| **templates** | 1 | 10+ | Plantillas HTML/Jinja2 |
| **migrations** | 1 | 5+ | Scripts SQL |

### Dependencias Externas Principales

| Categoría | Paquetes |
|-----------|----------|
| **Web Framework** | Flask, Flask-SQLAlchemy, Flask-CORS |
| **Database** | SQLAlchemy, psycopg2, redis |
| **Validation** | Pydantic |
| **AI/ML** | openai, anthropic, transformers, chromadb |
| **Twitter** | tweepy |
| **Security** | PyJWT, bcrypt |
| **OCR** | pdf2image, Pillow, PyMuPDF |
| **Utilities** | python-dotenv, requests |

---

## 11. Estructura de Archivos Completa

```
castor/
├── services/
│   ├── core/                    # Core Service (Auth)
│   │   ├── app/
│   │   │   ├── __init__.py
│   │   │   ├── routes/
│   │   │   ├── models/
│   │   │   ├── schemas/
│   │   │   └── services/
│   │   ├── utils/
│   │   ├── main.py
│   │   ├── config.py
│   │   ├── Dockerfile
│   │   └── requirements.txt
│   │
│   ├── e14-service/             # E-14 Service (OCR)
│   │   ├── app/
│   │   │   ├── __init__.py
│   │   │   ├── routes/
│   │   │   ├── models/
│   │   │   ├── schemas/
│   │   │   └── services/
│   │   │       ├── ocr/
│   │   │       └── validation/
│   │   ├── migrations/
│   │   ├── utils/
│   │   ├── main.py
│   │   ├── config.py
│   │   ├── Dockerfile
│   │   └── requirements.txt
│   │
│   └── dashboard-ia/            # Dashboard Service
│       ├── app/
│       │   ├── __init__.py
│       │   ├── routes/
│       │   ├── models/
│       │   ├── schemas/
│       │   └── services/
│       │       ├── twitter/
│       │       ├── sentiment/
│       │       ├── ai/
│       │       └── forecast/
│       ├── utils/
│       ├── main.py
│       ├── config.py
│       ├── Dockerfile
│       └── requirements.txt
│
├── shared/                      # Shared Components
│   ├── config/
│   ├── database/
│   ├── cache/
│   ├── resilience/
│   ├── http/
│   ├── exceptions/
│   └── utils/
│
├── backend/                     # Backend Monolítico
│   ├── app/
│   │   ├── __init__.py
│   │   ├── routes/
│   │   └── ...
│   ├── services/
│   ├── utils/
│   └── config.py
│
├── static/                      # Frontend Assets
│   ├── css/
│   ├── js/
│   ├── data/
│   ├── manifest.json
│   └── sw.js
│
├── templates/                   # Jinja2 Templates
│   ├── base.html
│   ├── webpage.html
│   ├── campaign.html
│   └── ...
│
├── nginx/                       # Nginx Config
│   ├── nginx.conf
│   └── ssl/
│
├── docker-compose.yml
├── .env
└── README.md
```
